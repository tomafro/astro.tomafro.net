<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tom Ward's personal website">
    <meta name="sha">
    <link rel="alternate" type="application/rss+xml" title="Weeknotes RSS feed for Tom Ward's Blog" href="/weeknotes/rss.xml">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preload" href="/fonts/rubik.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/rubik-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/fira-code.woff2" as="font" type="font/woff2" crossorigin>
    <meta name="generator" content="Astro v2.0.14">
    <title>Using indexes in rails: Index your associations - Tom Ward's Blog</title>
  <link rel="stylesheet" href="/_astro/_...slug_.5b1b7a84.css" /></head>
  <body class="baseline">
    

<header class="astro-WOK3G3JL" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="container astro-WOK3G3JL">
    <nav class="astro-WOK3G3JL">
      <ul class="sections astro-WOK3G3JL">
        <li class="astro-WOK3G3JL"><a href="/" class="astro-WOK3G3JL">About</a></li>
        <li class="astro-WOK3G3JL"><a href="/weeknotes" class="astro-WOK3G3JL">Weeknotes</a></li>
        <li class="astro-WOK3G3JL"><a href="/projects" class="astro-WOK3G3JL">Projects</a></li>
      </ul>
      <ul class="icons astro-WOK3G3JL">
        <li class="astro-WOK3G3JL">
          <a href="https://hachyderm.io/@tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://instagram.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://github.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path>
</svg></a>
        </li>
      </ul>
    </nav>
  </div>
</header>
    
<main class="astro-UGUFLI7P" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="bounds astro-UGUFLI7P">
    <article>
    <hgroup>
      <h1>Using indexes in rails: Index your associations</h1>
      <h2>
            <time datetime="2009-08-11T00:00:00.000Z">August 11th 2009</time>
          </h2>
    </hgroup>
    <p>Many rails developers are great at building applications but have limited experience in database design.  As a consequence, projects often have half-baked indexing strategies, and as a result suffer bad performance.</p>
<p>To try and improve this I’ve planned a series of posts on indexes, targetted at rails developers.  In this first post I’ll [introduce indexes and how to index your associations]([object Object]), then I’ll write about choosing additional indexes to improve query performance, and finally how to avoid redundant and duplicate indexes.</p>
<h3 id="a-brief-overview-of-database-indexes">A brief overview of database indexes</h3>
<p><a href="http://en.wikipedia.org/wiki/Index_(database)">Wikipedia states that</a> ‘a database index is a data structure that improves the speed of operations on a database table’.  Unfortunately, this improvement comes at a cost.</p>
<p>For every index on a table, there is a penalty both when inserting and updating rows.  Indexes also take up space on disk and in memory, which can affect the efficiency of queries.  Finally, having too many indexes can cause databases to choose between them poorly, actually harming performance rather than improving it.</p>
<p>So while indexing is important, we shouldn’t just throw indexes at our slow queries: we need to choose carefully how to index our data.</p>
<h3 id="indexing-simple-associations">Indexing simple associations</h3>
<p>By far the most common performance problem I’ve encountered in rails projects is a lack of indexes on foreign keys.  There’s no real excuse for this - not indexing foreign keys can cripple your app.</p>
<p>Take the following schema:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">create_table users </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string :login</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">create_table conversations </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string  :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">integer :user_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>We can use this to map a one-to-many relationship between users and conversations, where <code>user_id</code> as the foreign key.</p>
<p>Here are the models to do that:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">User</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  has_many :conversations</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Conversation</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :user</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>With these models, to find all conversations for a particular user we’d use <code>user.conversations</code>, which in turns uses sql like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">SELECT</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> conversations </span><span style="color:var(--astro-code-token-keyword)">WHERE</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">user_id</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">41</span><span style="color:var(--astro-code-color-text)">;</span></span></code></pre>
<p>I can run this query on a test database which I’ve randomly populated with 1,000,000 rows, to see how long it takes.  Note, I’ve cut out the actual results as they are unimportant:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (1.42 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ALL  | NULL          | NULL    | NULL  | 1001111 | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>Although the query is simple, it took 1.42 seconds.  The <code>key</code> column show the key or index that MySQL decided to use, in this case <code>NULL</code> as there are no indexes.  The <code>rows</code> column is also relevant.  It shows that MySQL will need to look at around 1,000,000 rows; that’s a lot of data being loaded and compared.</p>
<h3 id="what-a-difference-just-an-index-makes">What a difference just an index makes</h3>
<p>If we then add an index on <code>user_id</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_index :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :user_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :name </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;user_id_ix&#39;</span></span></code></pre>
<p>And do the same select:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | used_id_ix    | 5       | const |  108    | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>The difference is remarkable.  From over 1.4 seconds to about 1 hundredth.  Unless you have a cast-iron reason not to, index your foreign keys.</p>
<h3 id="indexing-polymorphic-associations">Indexing polymorphic associations</h3>
<p>So for simple associations, we can add an index on the foreign_key column.  For polymorphic associations the foreign key is made up of two columns, one for the <code>id</code> and one for the <code>type</code>.  Let’s add another association to our models to illustrate this.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_column :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :integer</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">add_column :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_type</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :string</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">create_table :artworks </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string :title</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Artwork</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  has_one :conversation</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :as </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Conversation</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :polymorphic </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Here we’ve added an association between Artwork and Conversation, where an artwork can be the subject of a conversation.  From an artwork, we can find the related conversation (if any) with <code>artwork.conversation</code> which will use the following SQL:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">SELECT</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> conversations </span><span style="color:var(--astro-code-token-keyword)">WHERE</span><span style="color:var(--astro-code-color-text)"> subject_id </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">196</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">and</span><span style="color:var(--astro-code-color-text)"> subject_type </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;Artwork&#39;</span><span style="color:var(--astro-code-color-text)">;</span></span></code></pre>
<p>Again the query takes around 1.4 seconds without any indexes.  Now though, we have a choice on what to index.  We can index either <code>subject_type</code> on its own, <code>subject_id</code> on its own, or both together.</p>
<p>Let’s try each in turn, and measure the performance.</p>
<p>First, an index on just <code>subject_type</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.31 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_type_ix   | 5       | const | 89511   | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>An index on just <code>subject_id</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_ix     | 5       | const | 204     | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>An index on <code>subject_id, subject_type</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+--------------------+---------+-------+---------+-------------+
| select_type | type | key                | key_len | ref   | rows    | Extra       |
+-------------+------+--------------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_and_type_ix | 5       | const | 5       | Using where |
+-------------+------+--------------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>So <code>subject_type</code> compared ~90,000 rows in 0.31 seconds, <code>subject_id</code> compared ~200 rows in 0.01 seconds and <code>subject_id, subject_type</code> compared 4 rows also in 0.01 seconds.  We should add an index to <code>subject_id, subject_type</code> as so:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_index :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> [:subject_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_type]</span></span></code></pre>
<h3 id="wrapping-up">Wrapping up</h3>
<p>This should give a basic overview of indexes and the performance improvements they can give.  Hopefully I’ve shown that <strong>foreign_keys should always be indexed</strong>, and how to index them.  The next article (which I hope to publish later this week) will explain more about how to reason about indexes, and how to identify additional indexes (beyond those on foreign keys) to add.</p>
  </article>
  </div>
</main>
    
  </body></html>