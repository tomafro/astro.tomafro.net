<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tom Ward's personal website">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preload" href="/fonts/rubik.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/rubik-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/fira-code.woff2" as="font" type="font/woff2" crossorigin>
    <meta name="generator" content="Astro v2.0.14">
    <title>Articles - Tom Ward's Blog</title>
  <link rel="stylesheet" href="/_astro/_...slug_.e69cd1cc.css" /></head>
  <body class="baseline">
    

<header class="astro-WOK3G3JL" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="container astro-WOK3G3JL">
    <nav class="astro-WOK3G3JL">
      <ul class="sections astro-WOK3G3JL">
        <li class="astro-WOK3G3JL"><a href="/" class="astro-WOK3G3JL">About</a></li>
        <li class="astro-WOK3G3JL"><a href="/weeknotes" class="astro-WOK3G3JL">Weeknotes</a></li>
        <li class="astro-WOK3G3JL"><a href="/projects" class="astro-WOK3G3JL">Projects</a></li>
      </ul>
      <ul class="icons astro-WOK3G3JL">
        <li class="astro-WOK3G3JL">
          <a href="https://hachyderm.io/@tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://instagram.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://github.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path>
</svg></a>
        </li>
      </ul>
    </nav>
  </div>
</header>
    
<main class="astro-UGUFLI7P" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="bounds astro-UGUFLI7P">
    <h1>Articles</h1><ul class="content-list">
    <li>
            <h2>
              <a href="2012/02/working-inside-government">
                Working inside government
              </a>
            </h2>
            <p>Since September, I and the other <a href="http://gofreerange.com">Go Free Range</a> guys have been working for the government.  We’ve been helping the able and growing <a href="http://digital.cabinetoffice.gov.uk/">Government Digital Service</a> to build <a href="https://github.com/alphagov/whitehall">whitehall</a>, our code name for the <a href="https://www.gov.uk/government">Inside Government section of gov.uk</a>.  Yesterday we removed the password and opened our doors to the public.</p>
<div class="browsershots"><a href="https://www.gov.uk/government/organisations/department-for-international-development"><img class="browsershot" src="/images/dfid.thumb.png"/></a><a href="https://www.gov.uk/government/policies/human-rights"><img class="browsershot" src="/images/promoting-human-rights.thumb.png"/></a><a href="https://www.gov.uk/government/organisations"><img class="browsershot" src="/images/departments.thumb.png"/></a></div>
<p>For those who don’t know, <a href="https://www.gov.uk">gov.uk</a> is the UK government’s attempt to not only consolidate government websites to a single domain, but also build these sites in the right way.  That means <a href="https://www.pivotaltracker.com/projects/367813">public</a>, <a href="https://github.com/alphagov/whitehall">open source</a>, continual delivery and more.</p>
<p>While the first part of <a href="https://www.gov.uk">gov.uk</a> focussed on helping citizens, <a href="https://www.gov.uk/government">Inside Government</a> is about the business of government.  <a href="https://www.gov.uk/government/policy-topics">What policies</a> the government has, <a href="https://www.gov.uk/government/policies/launching-the-single-domain">how it’s implementing them</a>, not to mention the <a href="https://www.gov.uk/government/news-and-speeches">news and speeches</a>, <a href="https://www.gov.uk/government/publications">publications</a>, <a href="https://www.gov.uk/government/consultations">consultations</a> and other things the government does each day.</p>
<p>It’s only the first release of many, a small glimpse into what will one day be.  How it ends up will be shaped by <a href="https://www.gov.uk/feedback">feedback from the people who use it</a>.</p>
          </li><li>
            <h2>
              <a href="2012/06/tip-bundler-with-binstubs">
                Tip: Bundler with --binstubs
              </a>
            </h2>
            <p>In <a href="/2011/09/tip-automatic-bundle-exec-for-rake-and-more">a previous blog</a>, I wrote how I’d aliased commands such as <code>rake</code>, <code>cap</code> and <code>rspec</code> to run either with or without <code>bundle exec</code>, based on the presence of a <code>Gemfile</code>.  I gave up on that a while ago.  Instead, I’ve started installing all my bundles like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">bundle install --path .bundle/gems --binstubs .bundle/bin</span></span></code></pre>
<p>I often use features like <code>bundle open &lt;gem&gt;</code> to debug and edit failing gems, so I like to keep each application’s gems isolated.  The <code>--path .bundle/gems</code> installs them within an application’s <code>.bundle</code> directory.  As well as isolating my gems, it has the added benefit that I can blow away the gemset with <code>rm -rf .bundle</code></p>
<p>The <code>--binstubs .bundle/bin</code> option installs bundle-aware scripts for each command provided by a bundled gem.  For example, a bundle including <code>rake</code> will generate a <code>.bundle/bin/rake</code> script.  By adding <code>./.bundle/bin</code> to the front of my environment <code>PATH</code>, the bundled version of <code>rake</code> will run when I’m in the application folder.  I never have to type <code>bundle exec</code>!</p>
<p>Obviously typing that long <code>bundle install</code> command each time is tedious, so I’ve aliased it to <code>bi</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">alias</span><span style="color:var(--astro-code-color-text)"> bi=</span><span style="color:var(--astro-code-token-string-expression)">&#39;bundle install --path .bundle/gems --binstubs .bundle/bin&#39;</span></span></code></pre>
<p>I’ve been using these options for a few months, and so far I’m very happy with them.</p>
          </li><li>
            <h2>
              <a href="2012/11/past-present-future">
                Past, Present and Future
              </a>
            </h2>
            <p>For me and the rest of <a href="https://gofreerange.com">Go Free Range</a>, the big event this week was the public launch of <a href="https://www.gov.uk/government">Inside Government</a>, the government focussed part of <a href="https://www.gov.uk">GOV.UK</a>.  Inside Government aims to replace the majority of government department and agency websites with a single place for all news, policies, publications and consultations.  On Wednesday, the first two department websites (for the <a href="https://www.gov.uk/dft">Department for Transport</a> and the <a href="https://www.gov.uk/dclg">Department for Communities and Local Government</a>) were moved across.</p>
<div class="browsershots"><a href="https://www.gov.uk/government"><img class="browsershot" src="/images/inside-government.png"/></a><a href="https://www.gov.uk/government/organisations/department-for-communities-and-local-government"><img class="browsershot" src="/images/inside-government-dclg.png"/></a><a href="https://www.gov.uk/government/policies/bringing-people-together-in-strong-united-communities"><img class="browsershot" src="/images/inside-government-policy.png"/></a></div>
<p>We’ve been working on this project for 14 months, from the <a href="https://github.com/alphagov/whitehall/commit/8fa2772">initial commit</a>, through the <a href="http://tomafro.net/2012/02/working-inside-government">beta launch</a> right up until today.  I’ve enjoyed it, but it has been extremely hard work.  And although there are hundreds of things I’d still like to change, there are hundreds more I’m proud of.</p>
<h2 id="harmonia">Harmonia</h2>
<p>As well as <a href="https://www.gov.uk/government">Inside Government</a>, we’ve also been slowly inviting people to <a href="https://harmonia.io">Harmonia</a>, our ‘virtual office manager’.  In case you haven’t read the <a href="http://gofreerange.com/blog">Go Free Range blog</a>, <a href="https://harmonia.io">Harmonia</a> is a tool we use to assign all the tasks needed to keep our company running.  Rather than use a schedule, each piece of work is assigned in a way designed to be both random and fair.</p>
<div class="browsershots"><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-signup.png"/></a><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-dashboard.png"/></a><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-task.png"/></a></div>
<p>One variation or another of <a href="https://harmonia.io">Harmonia</a> has been helping us for well over a year, but now we’ve built a web app for everyone to use.  It’s still a bit rough around the edges, but we’d love it if people <a href="https://harmonia.io">signed up</a> and gave us feedback.  We’re building this because we want to learn how to build better products, for the future of <a href="http://gofreerange.com">Go Free Range</a>.</p>
          </li><li>
            <h2>
              <a href="2012/12/deploying-harmonia-with-recap">
                Deploying a rails app from scratch using recap
              </a>
            </h2>
            <p>If you follow <a href="http://gofreerange.com/blog">our company blog</a> you’ll know that we’re working on <a href="http://harmonia.io">Harmonia</a>, our virtual office manager.  I thought I’d explain how we use <a href="https://github.com/freerange/recap">recap</a> to deploy harmonia, to show how easy and fast <a href="https://github.com/freerange/recap">recap</a> makes application deployment.</p>
<p><a href="https://harmonia.io">Harmonia</a> is a fairly standard rails application.  As well as a web front-end, it has two other processes.  A queue <code>worker</code> is used to send outgoing emails, whilst the core of the application is the <code>ticker</code>; a process which ‘ticks’ every minute, assigning tasks to team members.  We use <a href="https://github.com/ddollar/foreman">foreman</a> to declare these processes in the following <code>Procfile</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">web</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec unicorn -p $PORT -c unicorn.conf.rb</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">ticker</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec rails runner script/ticker.rb</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">worker</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec rake environment resque:work QUEUE=assignments VVERBOSE=1</span></span></code></pre>
<p>All of these processes touch application code, so whenever we deploy a new version of the app (which we do frequently) they need to be restarted.  Our app also has a database with associated migrations, uses environment variables like <code>DATABASE_URL</code> for configuration, and has a number of gem dependencies managed by bundler.</p>
<p>This is all handled by <a href="https://github.com/freerange/recap">recap</a>.</p>
<h2 id="getting-started---adding-recap-to-the-project">Getting started - adding recap to the project</h2>
<p>Using recap with a rails project is simple.  First add <code>gem &#39;recap&#39;</code> to the <code>Gemfile</code> and run <code>bundle install</code>.  Next run <code>bundle exec recap setup</code>, which will generate a <code>Capfile</code>, guessing values for the git repository and app name.  You should check these values and change the server to point to your app server.  As an example, the complete <code>Capfile</code> for harmonia is shown below:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;recap/recipes/rails&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">set :application</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;harmonia&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">set :repository</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;git@github.com:freerange/harmonia.git&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">server </span><span style="color:var(--astro-code-token-string-expression)">&#39;bison.harmonia.io&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :app</span></span></code></pre>
<p>Applications deployed with <a href="https://github.com/freerange/recap">recap</a> need their own user, owning all files and processes.  Assuming we can <code>ssh</code> into our server and are listed as a <code>sudoer</code>, we can create this user automatically  running <code>cap bootstrap</code>.  This will also add our own <code>ssh</code> user to the application group, allowing it to deploy the application.</p>
<p>Next we can set any environment variables we need for configuration.  These are loaded in the application user’s <code>.profile</code>, so are available to all processes started by <a href="https://github.com/freerange/recap">recap</a>.  In harmonia we set our smtp credentials, the server port, some api keys and more, using commands like <code>cap env:set PORT=7000</code> and <code>cap env:set SMTP_PASSWORD=secret</code>.</p>
<p>The app is now almost ready to deploy.  We can prepare it for deployment with <code>cap deploy:setup</code>, which clones the code repository, installs our gem bundle, sets up the database and precompiles our assets.</p>
<p>Finally, running <code>cap deploy</code> will start the app for the first time, launching each process defined in the <code>Procfile</code> with the environment variables we previously set.</p>
<h2 id="really-fast-deployments">Really fast deployments</h2>
<p>While <a href="https://github.com/freerange/recap">recap</a> makes it very easy to get apps up and running the first time, it comes into its doing subsequent deployments.  At <a href="http://gofreerange.com">Go Free Range</a> we like to deploy apps we’re working on very frequently.  One thing that helps ensure we do this is making each deployment as fast as it can be.</p>
<p>Using <code>git</code> as recap does is already a very quick way to get code changes onto servers, but recap takes things a step further.  By testing to see which files have changed it knows which tasks can be skipped.  For example, database migrations won’t be run if <code>db/schema.rb</code> has not changed; the gem bundle won’t be re-installed unless <code>Gemfile.lock</code> has been updated, and foreman process scripts won’t be exported if the <code>Procfile</code> is unchanged.  In fact, if these files don’t exist, these tasks will never run at all.</p>
<h2 id="the-future">The future</h2>
<p>Using <a href="https://github.com/freerange/recap">recap</a> with <a href="https://harmonia.io">Harmonia</a> has made our deployment process very fast and simple.  When the main harmonia server became over-burdened and we decided to commission a new machine dedicated to harmonia, recap made that process quick and painless.  As well as harmonia, recap is also used to deploy <a href="http://gofreerange.com">the Go Free Range website</a>, <a href="http://tomafro.net">this blog</a>, and a number of other small sites and projects where it has proven itself well.  For larger projects, there are some features (such as more control as to what processes run where) that are missing, but I plan to add these in the next release.  For all other sites, recap has proven itself a lightweight and capable alternative to the standard Capistrano deployment recipes.</p>
          </li><li>
            <h2>
              <a href="2012/12/infinite-sequences-in-ruby">
                Infinite sequences in ruby
              </a>
            </h2>
            <p>One feature of <a href="https://harmonia.io">harmonia</a> is tasks that recur on a schedule, e.g. every Thursday, or on the 30th day of each month.  For these tasks we need to know not just when they’ll next occur, but also things like the next 4 occurrences, or all occurrences this month.</p>
<p>To do this we’ve used a technique more common in <a href="http://clojure.org/">clojure</a>: using an infinite sequence.</p>
<h2 id="defining-simple-infinite-sequences">Defining simple infinite sequences</h2>
<p>Ruby 1.9 and above let us define infinite sequences using the <code>Enumerator</code> class.  A simple example is the sequence of integers:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Here’s how this works.  The block passed to <code>Enumerator.new</code> defines our sequence.  It takes a <code>yielder</code> argument with a special method <code>#yield</code>, used to return elements in the sequence.  Whenever <code>#yield</code> is called, execution of the block stops.  Execution only restarts <em>if</em> more elements are needed, making the sequence <em>lazy</em>.  The <code>Enumerator</code> class handles this stopping and starting execution — we only need to worry about how to generate each element.</p>
<p>Most of the code above is concerned with looping and yielding values, not generating them.  We can factor this out, giving us a method that makes it trivial to define new sequences:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>When using infinite sequences laziness is extremely important, as it’s impossible to generate all members of an infinite list in anything less than infinite time.  A sequence that outputs whenever a new value is calculated shows this laziness in action:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Calculating result </span><span style="color:var(--astro-code-token-string-expression)">#{n}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-punctuation)">;</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Now we can define sequences, how can we use them?  We’ve already seen that we can <code>#take</code> any number of elements from our sequence.  We can also use <code>#take_while</code> to take elements until a condition is met, such as finding all square numbers under 250:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take_while {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">250</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">100</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">144</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">196</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>In fact all <code>Enumerable</code> methods are available, but we have to take care in using them.  As our sequences are infinite, any method that iterates over all members has the potential to take an infinite amount of time.  For example calling <code>#any?</code> will either return true (if a matching element exists) or never return.</p>
<p>Another big drawback is that when we call <code>Enumerable</code> methods, laziness isn’t preserved.  Suppose we want the first 5 odd square numbers.  We might try the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span></code></pre>
<p>Unfortunately this will never return.  Even though we only want a finite set of results, the call to <code>#select</code> operates on the full infinite sequence before it returns.  <code>#take(5)</code> is never called.  The same problem exists with <code>#map</code>, <code>#drop</code>, <code>#reject</code> and more.</p>
<h2 id="preserving-laziness-across-derived-sequences">Preserving laziness across derived sequences</h2>
<p>Without laziness preservation, our sequences seem of limited use.  In ruby 2.0 we can use <code>#lazy</code> to make our sequences lazier, but in 1.9 this isn’t available to us.  Thankfully we can get around this by generating lazy versions of Enumerable methods ourselves.  Let’s take the previous example, finding the first 5 odd square numbers.  We hit a roadblock because <code>#select</code> never returned.  If instead of using <code>#select</code> we use a new <code>Enumerator</code> to do our selecting, we can work around this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">square</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield square </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> (square </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">289</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">361</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Our new <code>Enumerator</code> iterates <em>lazily</em> through our original sequence, yielding only odd values.  We’ve chained two enumerators together to preserve laziness.</p>
<p>This is all a bit cumbersome as is, but we can turn this into a ‘#select’ method on a new <code>LazyEnumerator</code> class:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">lazy_sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">LazyEnumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p><code>#reject</code> and <code>#map</code> can be chained in a similar way to <code>#select</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">reject</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">unless</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">map</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p><code>#drop</code> and <code>#drop_while</code> are slightly more complicated, but follow a similar pattern.  The main difference being that they need to keep track of how much to drop:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">n</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped_enough </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> index</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped_enough </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">&gt;=</span><span style="color:var(--astro-code-color-text)"> n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> dropped_enough</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop_while</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      match_found </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        match_found </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(element)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> match_found</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Together, these methods give us a <code>LazyEnumerator</code> that can be chained in a great number of ways, giving our sequences a lot of power.  <code>#take</code> and <code>#drop</code> let us select which members of a sequence we’re interested, while <code>#select</code>, <code>#reject</code> and <code>#map</code> allow us to build new sequences from existing ones:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">map {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">drop(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">441</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">529</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">625</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">729</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">841</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">961</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1089</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1369</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1521</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Using only a few simple methods, we’ve been able to answer a complicated (though contrived) question, what are the second ten odd square numbers?  This particular answer may not be interesting, but the technique of defining and deriving infinite sequences is much more general and useful.  This is only a small sample of what you can do with them.</p>
          </li><li>
            <h2>
              <a href="2023/02/using-direnv-to-make-life-easier">
                Using direnv to make life easier
              </a>
            </h2>
            <p>One of the tools I find most useful for local development is <a href="https://direnv.net/">direnv</a>. It’s one of a number of similar utilities that hooks into your shell, and alters the environment when you enter or leave a directory.</p>
<p>To give you an example, if you have a folder <code>~/example</code> with the file <code>~/example/.envrc</code></p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> EXAMPLE_NAME=</span><span style="color:var(--astro-code-token-string-expression)">&quot;Danie&quot;</span></span></code></pre>
<p>Then when in your shell session you <code>cd</code> into <code>~/example</code> it will export the <code>EXAMPLE_NAME</code> variable:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/example</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: loading </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/example/.envrc</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: </span><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> +EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">echo</span><span style="color:var(--astro-code-color-text)"> Hello $EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">Hello Danie</span></span></code></pre>
<p>Just as importantly, when you navigate away, the variable will be unset:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: unloading</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">echo</span><span style="color:var(--astro-code-color-text)"> Hello $EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">Hello</span></span></code></pre>
<h2 id="simple-use-cases">Simple use cases</h2>
<p>More command line tools than you might think make use of environment variables, as of course does your shell. There are some obvious and less obvious uses for direnv. Here are a few that I use:</p>
<h3 id="quickly-launch-the-correct-development-database">QUICKLY LAUNCH THE CORRECT DEVELOPMENT DATABASE</h3>
<p>Setting <a href="https://www.postgresql.org/docs/current/libpq-envars.html">Postgres Environment Variables</a> <code>PGDATABASE</code>, <code>PGUSER</code>, and <code>PGPASSWORD</code><sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup> to match my development database credentials means that when in a project folder, <code>psql</code> will open the correct database.</p>
<h3 id="securely-use-aws-secrets-via-1password">SECURELY USE AWS SECRETS (via 1Password)</h3>
<p>Unlike a development database password, I’m more careful with AWS credentials. While <code>AWS_PROFILE</code>, <code>AWS_REGION</code>, and <code>AWS_ACCESS_KEY_ID</code> are safe to share, I prefer to keep <code>AWS_SECRET_ACCESS_KEY</code> values out of my <code>.envrc</code> files. But that doesn’t mean I can’t use them. I store these secrets in 1Password and use the CLI to retrieve them. So my <code>.envrc</code> looks like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_REGION=eu-west-2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_ACCESS_KEY_ID=AKABCDEFGHIJKLMNO</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_SECRET_ACCESS_KEY=</span><span style="color:var(--astro-code-token-string-expression)">&quot;$(op </span><span style="color:var(--astro-code-token-function)">read</span><span style="color:var(--astro-code-token-string-expression)"> op://dev/aws/SECRET_ACCESS_KEY)&quot;</span></span></code></pre>
<p>The environment variable is still set to the secret, but the secret itself is stored more securely than in an unencrypted <code>.envrc</code>.</p>
<h3 id="add-arbitrary-commands-to-the-path">Add arbitrary commands to the path</h3>
<p>In one of the clojure projects I work on, the command I use start the REPL is:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">clojure -A:dev:test:backend:backend-test:system-test:repl</span></span></code></pre>
<p>To save having to type this (or more accurately — search the shell history), I put it in a very short script, saved (and <code>.gitignored</code>) in <code>.local/bin/repl</code>. Then in that project’s <code>.envrc</code> I’ve simply put:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">PATH_add ./.local/bin</span></span></code></pre>
<p>When in this project folder, typing <code>repl</code> launches the repl.</p>
<section data-footnotes="" class="footnotes"><p class="sr-only" id="footnote-label">Footnotes</p>
<ol>
<li id="user-content-fn-1">
<p>If I’d set one. YOLO. <a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>
          </li>
  </ul>
  </div>
</main>
    
  </body></html>