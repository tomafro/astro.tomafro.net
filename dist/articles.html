<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tom Ward's personal website">
    <meta name="sha">
    <link rel="alternate" type="application/rss+xml" title="Weeknotes RSS feed for Tom Ward's Blog" href="/weeknotes/rss.xml">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preload" href="/fonts/rubik.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/rubik-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/fira-code.woff2" as="font" type="font/woff2" crossorigin>
    <meta name="generator" content="Astro v2.0.14">
    <title>Articles - Tom Ward's Blog</title>
  <link rel="stylesheet" href="/_astro/_...slug_.5b1b7a84.css" /></head>
  <body class="baseline">
    

<header class="astro-WOK3G3JL" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="container astro-WOK3G3JL">
    <nav class="astro-WOK3G3JL">
      <ul class="sections astro-WOK3G3JL">
        <li class="astro-WOK3G3JL"><a href="/" class="astro-WOK3G3JL">About</a></li>
        <li class="astro-WOK3G3JL"><a href="/weeknotes" class="astro-WOK3G3JL">Weeknotes</a></li>
        <li class="astro-WOK3G3JL"><a href="/projects" class="astro-WOK3G3JL">Projects</a></li>
      </ul>
      <ul class="icons astro-WOK3G3JL">
        <li class="astro-WOK3G3JL">
          <a href="https://hachyderm.io/@tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://instagram.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://github.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path>
</svg></a>
        </li>
      </ul>
    </nav>
  </div>
</header>
    
<main class="astro-UGUFLI7P" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="bounds astro-UGUFLI7P">
    <h1>Articles</h1><ul class="content-list">
    <li>
            <h2>
              <a href="/2009/05/adam-sandersons-open-gem">Adam Sanderson&#39;s open_gem</a>
            </h2>
            <p>The latest version of <a href="http://rubygems.org/">rubygems</a> (1.3.2) now has an interface to add commands.  Making great use of this feature, <a href="http://endofline.wordpress.com/">Adam Sanderson</a> has written <a href="http://github.com/adamsanderson/open_gem">open_gem</a>, a simple but amazingly useful tool.</p>
<p>You use it like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ gem open activerecord</span></span></code></pre>
<p>This opens the activerecord gem in your favourite editor (taken from either <code>$GEM_OPEN_EDITOR</code> or <code>$EDITOR</code> environment variables).  If there are multiple versions of the gem installed, it will show a menu, letting you choose which version you require.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ gem open activerecord</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">Open which gem</span><span style="color:var(--astro-code-token-keyword)">?</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"> 1. activerecord 2.1.0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"> 2. activerecord 2.3.2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;</span></span></code></pre>
<p>open_gem itself is a gem, and can be installed with:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ gem install open_gem</span></span></code></pre>
<p>To get it working, you need to have <code>$EDITOR</code> set to something sensible:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ </span><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> EDITOR=mate</span></span></code></pre>
<p>If you’re running on OS X and use TextMate, you may have already set <code>$EDITOR</code> to <code>mate -w</code>, which let’s you use TextMate as the editor for git commit messages and much more.  However, the <code>-w</code> flag doesn’t work with open_gem, so set the <code>$GEM_OPEN_EDITOR</code> variable, and open_gem will use that instead:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ </span><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> GEM_OPEN_EDITOR=mate</span></span></code></pre>
<p>You should now be good to go.  If you want to see how it works, just use it on itself!</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">$ gem open open_gem</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/05/automatching-rails-paths-in-cucumber">Automatching rails paths in cucumber</a>
            </h2>
            <p>If you’re using <a href="http://cukes.info/">cucumber</a> as part of your testing, you probably have a <code>paths.rb</code> file that looks something like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">NavigationHelpers</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">path_to</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">page_name</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">case</span><span style="color:var(--astro-code-color-text)"> page_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">when</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">/the home page/</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      root_path</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">when</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">/the new client page/</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      new_client_path</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">when</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">/the clients page/</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      clients_path</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Add more page name =&gt; path mappings here</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">raise</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Can&#39;t find mapping from \&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{page_name}</span><span style="color:var(--astro-code-token-string-expression)">\&quot; to a path.\n&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-string-expression)">&quot;Now, go and add a mapping in features/support/paths.rb&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">World</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">NavigationHelpers</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"></span></code></pre>
<p>This let’s us use nice descriptive names in our scenarios, but it starts to become a pain when we add more and more paths.  So how can we make it better?</p>
<p>By automatically matching some rails paths.  Here’s the code:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">NavigationHelpers</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">path_to</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">page_name</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">case</span><span style="color:var(--astro-code-color-text)"> page_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">when</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">/the home page/</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      root_path</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Add more page name =&gt; path mappings here</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> match_rails_path_for(page_name)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">raise</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Can&#39;t find mapping from \&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{page_name}</span><span style="color:var(--astro-code-token-string-expression)">\&quot; to a path.\n&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-string-expression)">&quot;Now, go and add a mapping in features/support/paths.rb&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">match_rails_path_for</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">page_name</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> page_name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">match(</span><span style="color:var(--astro-code-token-string-expression)">/the (.*) page/</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)"> send </span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{$1</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">gsub</span><span style="color:var(--astro-code-token-string-expression)">(</span><span style="color:var(--astro-code-token-string-expression)">&quot; &quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;_&quot;</span><span style="color:var(--astro-code-token-string-expression)">)}</span><span style="color:var(--astro-code-token-string-expression)">_path&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">rescue</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">nil</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">World</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">NavigationHelpers</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"></span></code></pre>
<p>What it does is pretty simple.  Given a page name <code>the clients page</code> (with no other matches defined) it will try and send <code>clients_path</code>.  If successful, then it returns the result, otherwise nil.</p>
<p>Not the biggest improvement in the world, but it’s made my cucumber tests just a little bit easier to write.</p>
          </li><li>
            <h2>
              <a href="/2009/05/imitation-is-the-sincerest-form-of-flattery">If imitation is the sincerest form of flattery...</a>
            </h2>
            <p><a href="http://www.tiagoluchini.eu/">…consider me flattered</a>.</p>
          </li><li>
            <h2>
              <a href="/2009/05/using-rack-middleware-for-good-and-evil">Using Rack Middleware for good and evil</a>
            </h2>
            <p>So we all know that <a href="http://rack.rubyforge.org/">Rack</a> is awesome, and that we can use Rack::Middleware for all sorts of things: <a href="http://github.com/brynary/rack-bug/tree/master">debugging</a>, <a href="http://tomayko.com/src/rack-cache/">caching</a> and a <a href="http://github.com/rack/rack-contrib/tree/master">whole host more</a>.</p>
<p>What all these have in common (apart from maybe <a href="http://github.com/rack/rack-contrib/blob/8b6323c8eecc8279088987c52b27dda5d4cadf7b/lib/rack/contrib/evil.rb">Rack::Evil</a>) is that they’re all helpful.  They all make writing Rack applications easier.  Not my Middleware though.</p>
<h3 id="introducing-rackshuffler">Introducing Rack::Shuffler</h3>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Rack</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Shuffler</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">initialize</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">app</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      @app </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> app</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      @responses </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> []</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">call</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">env</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      @responses </span><span style="color:var(--astro-code-token-keyword)">&lt;&lt;</span><span style="color:var(--astro-code-color-text)"> @app</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(env)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      @responses[</span><span style="color:var(--astro-code-token-function)">rand</span><span style="color:var(--astro-code-color-text)">(@responses</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">size)]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">ensure</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      @responses</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">delete_at(</span><span style="color:var(--astro-code-token-function)">rand</span><span style="color:var(--astro-code-color-text)">(@responses</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">size)) </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> @responses</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">size </span><span style="color:var(--astro-code-token-keyword)">&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">100</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>I suggest you add it to a colleague’s app late on a Friday afternoon, and see how long it takes to drive them to insanity.</p>
          </li><li>
            <h2>
              <a href="/2009/05/an-objective-c-implementation-of-active-supports-inflector">An Objective-C implementation of ActiveSupport&#39;s Inflector</a>
            </h2>
            <p>Over the last week I’ve been playing with Objective-C, for fun rather than profit.  Here’s the first result of this dabbling - <a href="http://github.com/tomafro/ActiveSupportInflector/tree/master">an Objective-C implementation</a> of ActiveSupport’s pluralize and singularize methods.</p>
<p>It’s my first piece of code in the language, so I’d appreciate comments and feedback.</p>
          </li><li>
            <h2>
              <a href="/2009/05/read-active-record-columns-directly-from-the-class">Read ActiveRecord columns directly from the class</a>
            </h2>
            <p>Sometimes you want to read just a single column from a collection of records, without the overhead of instantiating each and every one.  You could just execute raw SQL, but it’s a shame to do away with the nice type conversion <code>ActiveRecord</code> provides.  It’d also be a pity to get rid of find scoping, amongst other goodness.</p>
<p>Enter <code>Tomafro::ColumnReader</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Tomafro</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-function)">ColumnReader</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">column_reader</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">column_name</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    name </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> options</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">delete(:as) </span><span style="color:var(--astro-code-token-keyword)">||</span><span style="color:var(--astro-code-color-text)"> column_name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_s</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">pluralize</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    column </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> columns_hash[column_name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_s]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">module_eval </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">      def self.</span><span style="color:var(--astro-code-token-string-expression)">#{name}</span><span style="color:var(--astro-code-token-string-expression)">(options = {</span><span style="color:var(--astro-code-color-text)">})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        merged </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> options</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">merge(:select </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;#{column_name}&#39;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        connection</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">select_all(construct_finder_sql(merged))</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          v </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> value</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">values</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">first</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          </span><span style="color:var(--astro-code-token-comment)">#{column.type_cast_code(&#39;v&#39;)}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Once you’ve extended <code>ActiveRecord::Base</code> with it, usage is simple.  In your models, declare which columns you want access to:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-constant)">ActiveRecord</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Base</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">extend</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Tomafro</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">ColumnReader</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Animal</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  column_reader </span><span style="color:var(--astro-code-token-string-expression)">&#39;id&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  column_reader </span><span style="color:var(--astro-code-token-string-expression)">&#39;name&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  named_scope :dangerous</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :conditions </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> {:carnivorous </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Once you’ve done this, you can access values directly from the class, respecting scope, limits and other finder options.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;, &#39;Zebra&#39;, &#39;Gazelle&#39;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names :limit </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;] (Normal finder options supported)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">dangerous</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;] (Scoping respected)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">ids</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [1, 2, 3] (Values cast correctly)</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/06/pimp-my-script-console">Pimp my script/console</a>
            </h2>
            <p>For a long time I’ve had <a href="http://github.com/tomafro/dotfiles/blob/master/dotfiles/irbrc">an .irbrc file</a> and a <a href="http://github.com/tomafro/dotfiles/blob/master/dotfiles/railsrc">.railsrc file</a>, setting up some simple helpers methods in my <code>irb</code> and <code>script/console</code> sessions.  Today though, I wanted to add some more helpers specific to the project I’m working on.  Specifically, I wanted to be able to use my <a href="http://github.com/notahat/machinist/tree/master">machinist</a> blueprints, to help me play around with some models.</p>
<p>Adding <a href="http://github.com/notahat/machinist/tree/master">machinist</a> isn’t as simple as just requiring my blueprints though — they require my ActiveRecord models, which aren’t available when <code>.irbrc</code> is loaded.  Luckily the solution is simple — just add a couple of lines to the configuration in environment.rb:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Initializer</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">run </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">config</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">defined?</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">IRB</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    config</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">gem </span><span style="color:var(--astro-code-token-string-expression)">&#39;faker&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    config</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">gem </span><span style="color:var(--astro-code-token-string-expression)">&#39;notahat-machinist&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :lib </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;machinist&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :source </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;http://gems.github.com&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">IRB</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">conf[:IRB_RC] </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Proc</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> { </span><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">join(</span><span style="color:var(--astro-code-token-constant)">RAILS_ROOT</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;config&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;console&quot;</span><span style="color:var(--astro-code-color-text)">) }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>The key part is the line starting <code>IRB.conf[:IRB_RC]</code>, which tells <code>irb</code> to run the given when the session starts.  Luckily, this happens after rails has finished initializing.  I’ve set it to require <code>config/console.rb</code>, to which I can add all sorts of configuration and helpers, knowing it will only get loaded in <code>script/console</code> sessions where I want these shortcuts, not in my general code.  Here it is:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">expand_path(</span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">dirname(__FILE__) </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;/../spec/blueprints.rb&quot;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">tomafro</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">Account</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">find_by_login(</span><span style="color:var(--astro-code-token-string-expression)">&quot;tomafro&quot;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">bbi</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">Client</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">find_by_name(</span><span style="color:var(--astro-code-token-string-expression)">&quot;Big Bad Industries&quot;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/07/dscl-the-easy-way-to-add-hosts-on-osx">dscl - the easy way to add hosts on OS X</a>
            </h2>
            <p>As a web developer, I often want several host names pointing at my local machine whilst developing and testing applications.  I may want to use Apache virtual hosts to serve multiple apps at once, or use subdomains to distinguish different accounts within a single application.</p>
<p>Previously, to set these host names up, I would manually edit <code>/etc/hosts</code>, adding entries like:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">127.0.0.1      twitter-killer.localhost</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">127.0.0.1      my-url-shortener-is-better-than-yours.localhost</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">127.0.0.1      yet-another-half-baked-idea.localhost</span></span></code></pre>
<p>This worked well on one level, but on another it just seemed wrong.  It’s very manual, prone to error and pretty hard to script.  Recently though, thanks to a hint from Chris Parsons, I’ve found another way: using <code>dscl</code>.</p>
<p><code>dscl</code>, or Directory Service command line utility to give it its full name, has many uses.  For a web developer, the most relevant is probably the ability to add, list and create local directory entries under <code>/Local/Defaults/Hosts</code> in the directory (not the file system).  These act like lines in <code>/etc/hosts</code> but can be manipulated easily from the command line.</p>
<p>To add an entry (easily the most interesting command) use:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">sudo dscl localhost -create /Local/Default/Hosts/twitter-killer.localhost IPAddress 127.0.0.1</span></span></code></pre>
<p>Once entries have been added, listing them is just as simple:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">sudo dscl localhost -list /Local/Default/Hosts IPAddress</span></span></code></pre>
<p>This produces a list in the form:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">twitter-killer.localhost                         127.0.0.1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">my-url-shortener-is-better-than-yours.localhost  127.0.0.1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">yet-another-half-baked-idea.localhost            127.0.0.1</span></span></code></pre>
<p>Finally, you can remove entries with:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">sudo dscl localhost -delete /Local/Default/Hosts/twitter-killer.localhost</span></span></code></pre>
<p>Once you’ve mastered these commands, the possibilities are endless.  Here’s a rake task to add all subdomains used in a project:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Application</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.subdomains</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">Client</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">all</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">client</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> client</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">subdomain }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">namespace :subdomains </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  task :add </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">Application</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">subdomains</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">subdomain</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-string-expression)">`sudo dscl localhost -create /Local/Default/Hosts/</span><span style="color:var(--astro-code-token-string-expression)">#{subdomain}</span><span style="color:var(--astro-code-token-string-expression)">.app.localhost IPAddress 127.0.0.1`</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  task :remove </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">Application</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">subdomains</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">subdomain</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-string-expression)">`sudo dscl localhost -delete /Local/Default/Hosts/</span><span style="color:var(--astro-code-token-string-expression)">#{subdomain}</span><span style="color:var(--astro-code-token-string-expression)">.app.localhost`</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Or if you’re using <a href="http://www.modrails.com/">passenger</a> for development, you can use a tool like <a href="http://github.com/lazyatom/hostess/tree/master">James Adam’s hostess</a> to automatically set up the host entry and virtual host entry for a site in one simple command.</p>
          </li><li>
            <h2>
              <a href="/2009/08/kernel-specific-zsh-dotfiles">Kernel specific ZSH dotfiles</a>
            </h2>
            <p>I work on a number of different machines, OS X based for development and Linux based for hosting.  I’ve added various aliases and other commands to my shell, and use <a href="http://github.com/tomafro/dotfiles">a github repository</a> to share this configuration between these machines.</p>
<p>This works well, but while most commands work commonly across Linux and OS X, there are some nasty differences.  One example is <code>ls</code> which takes different arguments on both systems; the default <code>ls</code> alias I use on OS X doesn’t work on Linux.  So how can we accommodate these differences, without removing all the shared configuration?</p>
<p>The answer is really simple.  Create kernel specific configuration files, and use a case statement to load the correct one.  The main obstacle was finding a way to distinguish between each kernel.  In the end I found the <code>$system_name</code> environment variable, which is set on both OS X and the servers I use.</p>
<p>Here’s the code:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">case</span><span style="color:var(--astro-code-color-text)"> $system_name </span><span style="color:var(--astro-code-token-keyword)">in</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  Darwin</span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-function)">source</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/.houseshare/zsh/kernel/darwin.zsh</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    ;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-function)">source</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/.houseshare/zsh/kernel/linux.zsh</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    ;;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">esac</span></span></code></pre>
<p>As I said, simple.</p>
          </li><li>
            <h2>
              <a href="/2009/08/the-cost-of-explicit-returns-in-ruby">The cost of explicit returns in ruby</a>
            </h2>
            <p>Yesterday <a href="http://m.onkey.org/2009/8/3/ruby-i-don-t-like-1-explicit-return">Pratik Naik wrote a post</a> on one of his pet hates - explicit returns in ruby.  I agree 100% with Pratik, I can’t stand them either.</p>
<p>In one of the comments, Chris Wanstrath posted <a href="http://gist.github.com/160718">this microbenchmark</a> showing that using explicit returns incurs a surprising performance hit.  It seemed crazy to me, so I thought I’d investigate further, running the benchmark on jruby and ruby 1.9 for comparison.</p>
<h3 id="ruby-187-2008-08-11-patchlevel-72">ruby 1.8.7 (2008-08-11 patchlevel 72)</h3>
<pre><p>user     system      total        real
explicit   3.420000   0.020000   3.440000 (  3.478501)
implicit   2.220000   0.000000   2.220000 (  2.236413)</p></pre>
<h3 id="jruby-116-ruby-186-patchlevel-114">jruby 1.1.6 (ruby 1.8.6 patchlevel 114)</h3>
<pre><p>user     system      total        real
explicit   2.611000   0.000000   2.611000 (  2.611001)
implicit   2.541000   0.000000   2.541000 (  2.541385)</p></pre>
<h3 id="ruby-191p0-2009-01-30-revision-21907">ruby 1.9.1p0 (2009-01-30 revision 21907)</h3>
<pre><p>user     system      total        real
explicit   1.580000   0.010000   1.590000 (  1.614273)
implicit   1.520000   0.000000   1.520000 (  1.537492)</p></pre>
<p>So neither jruby nor ruby 1.9 incur this penalty.</p>
<p>Is this good news or not?  If, like me, you consider explicit returns a code smell, I guess it doesn’t matter either way.</p>
          </li><li>
            <h2>
              <a href="/2009/08/tip-move-to-directory-and-open-in-textmate">Tip: Move to directory and open in TextMate</a>
            </h2>
            <p>Since adding this to <a href="http://github.com/tomafro/dotfiles/tree/master/zsh">my zsh configuration</a>, I’m finding I use it all the time:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-comment)"># Change directory and open TextMate in a single command</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)"># Usage: tm ~/Projects/sites/tomafro.net</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">tm</span><span style="color:var(--astro-code-token-punctuation)">()</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> $1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  mate $1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/08/using-indexes-in-rails-index-your-associations">Using indexes in rails: Index your associations</a>
            </h2>
            <p>Many rails developers are great at building applications but have limited experience in database design.  As a consequence, projects often have half-baked indexing strategies, and as a result suffer bad performance.</p>
<p>To try and improve this I’ve planned a series of posts on indexes, targetted at rails developers.  In this first post I’ll [introduce indexes and how to index your associations]([object Object]), then I’ll write about choosing additional indexes to improve query performance, and finally how to avoid redundant and duplicate indexes.</p>
<h3 id="a-brief-overview-of-database-indexes">A brief overview of database indexes</h3>
<p><a href="http://en.wikipedia.org/wiki/Index_(database)">Wikipedia states that</a> ‘a database index is a data structure that improves the speed of operations on a database table’.  Unfortunately, this improvement comes at a cost.</p>
<p>For every index on a table, there is a penalty both when inserting and updating rows.  Indexes also take up space on disk and in memory, which can affect the efficiency of queries.  Finally, having too many indexes can cause databases to choose between them poorly, actually harming performance rather than improving it.</p>
<p>So while indexing is important, we shouldn’t just throw indexes at our slow queries: we need to choose carefully how to index our data.</p>
<h3 id="indexing-simple-associations">Indexing simple associations</h3>
<p>By far the most common performance problem I’ve encountered in rails projects is a lack of indexes on foreign keys.  There’s no real excuse for this - not indexing foreign keys can cripple your app.</p>
<p>Take the following schema:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">create_table users </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string :login</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">create_table conversations </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string  :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">integer :user_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>We can use this to map a one-to-many relationship between users and conversations, where <code>user_id</code> as the foreign key.</p>
<p>Here are the models to do that:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">User</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  has_many :conversations</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Conversation</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :user</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>With these models, to find all conversations for a particular user we’d use <code>user.conversations</code>, which in turns uses sql like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">SELECT</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> conversations </span><span style="color:var(--astro-code-token-keyword)">WHERE</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">user_id</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">41</span><span style="color:var(--astro-code-color-text)">;</span></span></code></pre>
<p>I can run this query on a test database which I’ve randomly populated with 1,000,000 rows, to see how long it takes.  Note, I’ve cut out the actual results as they are unimportant:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (1.42 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ALL  | NULL          | NULL    | NULL  | 1001111 | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>Although the query is simple, it took 1.42 seconds.  The <code>key</code> column show the key or index that MySQL decided to use, in this case <code>NULL</code> as there are no indexes.  The <code>rows</code> column is also relevant.  It shows that MySQL will need to look at around 1,000,000 rows; that’s a lot of data being loaded and compared.</p>
<h3 id="what-a-difference-just-an-index-makes">What a difference just an index makes</h3>
<p>If we then add an index on <code>user_id</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_index :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :user_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :name </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;user_id_ix&#39;</span></span></code></pre>
<p>And do the same select:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | used_id_ix    | 5       | const |  108    | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>The difference is remarkable.  From over 1.4 seconds to about 1 hundredth.  Unless you have a cast-iron reason not to, index your foreign keys.</p>
<h3 id="indexing-polymorphic-associations">Indexing polymorphic associations</h3>
<p>So for simple associations, we can add an index on the foreign_key column.  For polymorphic associations the foreign key is made up of two columns, one for the <code>id</code> and one for the <code>type</code>.  Let’s add another association to our models to illustrate this.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_column :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :integer</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">add_column :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_type</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :string</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">create_table :artworks </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string :title</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Artwork</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  has_one :conversation</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :as </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Conversation</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :polymorphic </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Here we’ve added an association between Artwork and Conversation, where an artwork can be the subject of a conversation.  From an artwork, we can find the related conversation (if any) with <code>artwork.conversation</code> which will use the following SQL:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">SELECT</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> conversations </span><span style="color:var(--astro-code-token-keyword)">WHERE</span><span style="color:var(--astro-code-color-text)"> subject_id </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">196</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">and</span><span style="color:var(--astro-code-color-text)"> subject_type </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;Artwork&#39;</span><span style="color:var(--astro-code-color-text)">;</span></span></code></pre>
<p>Again the query takes around 1.4 seconds without any indexes.  Now though, we have a choice on what to index.  We can index either <code>subject_type</code> on its own, <code>subject_id</code> on its own, or both together.</p>
<p>Let’s try each in turn, and measure the performance.</p>
<p>First, an index on just <code>subject_type</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.31 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_type_ix   | 5       | const | 89511   | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>An index on just <code>subject_id</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_ix     | 5       | const | 204     | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>An index on <code>subject_id, subject_type</code>:</p>
<pre><p>mysql&gt; SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’;
12 rows in set (0.01 sec)</p><p>mysql&gt; EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = ‘Artwork’
+-------------+------+--------------------+---------+-------+---------+-------------+
| select_type | type | key                | key_len | ref   | rows    | Extra       |
+-------------+------+--------------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_and_type_ix | 5       | const | 5       | Using where |
+-------------+------+--------------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)</p></pre>
<p>So <code>subject_type</code> compared ~90,000 rows in 0.31 seconds, <code>subject_id</code> compared ~200 rows in 0.01 seconds and <code>subject_id, subject_type</code> compared 4 rows also in 0.01 seconds.  We should add an index to <code>subject_id, subject_type</code> as so:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_index :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> [:subject_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject_type]</span></span></code></pre>
<h3 id="wrapping-up">Wrapping up</h3>
<p>This should give a basic overview of indexes and the performance improvements they can give.  Hopefully I’ve shown that <strong>foreign_keys should always be indexed</strong>, and how to index them.  The next article (which I hope to publish later this week) will explain more about how to reason about indexes, and how to identify additional indexes (beyond those on foreign keys) to add.</p>
          </li><li>
            <h2>
              <a href="/2009/08/tip-create-and-move-to-directory">Tip: Create and move to directory</a>
            </h2>
            <p>Before my next post on database indexes, here’s a useful little function from the <a href="http://peepcode.com/products/advanced-command-line">Advanced Command Line peepcode screencast</a> (which I highly recommend).:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-comment)"># Create and move to a directory in a single command</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)"># Usage: take ~/Projects/tools/awesometer</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">take</span><span style="color:var(--astro-code-token-punctuation)">()</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  mkdir -p $1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> $1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/08/zsh-completion-for-gem-and-gem-open">ZSH Completion for gem and gem open</a>
            </h2>
            <p>I’ve been trying to get my head around the ZSH completion system.  It’s not easy, but I’m slowly making progress.</p>
<p>Here’s my first semi-successful attempt.  It provides command completion for <code>gem</code> (including installed commands) and gem name completion for specific gem commands (<code>update</code>, and <code>open</code> from <a href="http://tomafro.net/2009/05/adam-sandersons-open-gem">Adam Sanderson</a>).</p>
<p>So typing <code>gem &lt;tab&gt;</code> gives a list of possible commands, whilst <code>gem open &lt;tab&gt;</code> will complete with the names of the currently installed gems.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-comment)">#compdef gem</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">_gem_commands</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">()</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> [[ </span><span style="color:var(--astro-code-token-keyword)">-z</span><span style="color:var(--astro-code-color-text)"> $gem_commands ]] </span><span style="color:var(--astro-code-token-keyword)">;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">then</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    gem_commands=</span><span style="color:var(--astro-code-token-string-expression)">$(gem </span><span style="color:var(--astro-code-token-function)">help</span><span style="color:var(--astro-code-token-string-expression)"> commands </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-token-string-expression)"> grep &#39;^    [a-z]&#39; </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-token-string-expression)"> cut -d &quot; &quot; -f 5)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-comment)"># This seems unnecessary, but if I try to set gem_commands to an array, it falls over.</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">typeset</span><span style="color:var(--astro-code-color-text)"> -a gem_command_array</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  gem_command_array=(</span><span style="color:var(--astro-code-token-string-expression)">$(echo $gem_commands)</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  compadd $gem_command_array</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">_installed_gems</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">()</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> [[ </span><span style="color:var(--astro-code-token-keyword)">-z</span><span style="color:var(--astro-code-color-text)"> $installed_gems ]] </span><span style="color:var(--astro-code-token-keyword)">;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">then</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    installed_gems=(</span><span style="color:var(--astro-code-token-string-expression)">$(gem list </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-token-string-expression)"> grep &#39;^[A-Za-z]&#39; </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-token-string-expression)"> cut -d &quot; &quot; -f 1)</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">typeset</span><span style="color:var(--astro-code-color-text)"> -a installed_gem_array</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  installed_gem_array=(</span><span style="color:var(--astro-code-token-string-expression)">$(echo $installed_gems)</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  compadd $installed_gem_array</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string)">(( CURRENT </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-token-string)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-string)"> ))</span><span style="color:var(--astro-code-token-keyword)">;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">then</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  _gem_commands</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> [[ $words[2] </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> open </span><span style="color:var(--astro-code-token-keyword)">||</span><span style="color:var(--astro-code-color-text)"> $words[2] </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> update ]] </span><span style="color:var(--astro-code-token-keyword)">;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">then</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    _installed_gems</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">fi</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">fi</span></span></code></pre>
<p>As it’s a first attempt, it’s a long way from perfect.  I’ve <a href="http://gist.github.com/167309">put it on gist</a>, for other people to play with, and I’d appreciate any advice or improvements.  Specifically I’d like to know how to avoid the use of both <code>gem_command_array</code> and <code>gem_commands</code>.  I’d also like to know a better way to check if the given command is in the list <code>[open, update]</code>.</p>
<p>Please fork the gist, or <a href="http://twitter.com/tomafro">tweet me</a> with your suggestions.</p>
          </li><li>
            <h2>
              <a href="/2009/08/using-indexes-in-rails-choosing-additional-indexes">Using indexes in rails: Choosing additional indexes</a>
            </h2>
            <p><a href="http://tomafro.net/2009/08/using-indexes-in-rails-index-your-associations">The first part in this series of posts</a> looked at adding indexes to foreign keys, to improve the performance when navigating rails associations.  But many queries involve data other than just foreign keys.  With the judicious use of indexes, we can improve these too.</p>
<p>Let’s take the <code>conversations</code> table used in the first article, and add a column to hold the language, and some timestamps.  Here’s the full schema:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">create_table conversations </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">table</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string   :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">integer  :user_id</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :null </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">integer  :subject_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string   :subject_type</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">string   :language_code</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">datetime :created_at</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  table</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">datetime :updated_at</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>We want to split conversations by their languages, so we’ll add a <code>named_scope</code> to the Conversation class:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Conversation</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :user</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  belongs_to :subject</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :polymorphic </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  named_scope :in_language</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">lambda</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">language</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    { :conditions </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> {:language_code </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> language}}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Using <code>Conversation.in_language &#39;en&#39;</code> will now get us all conversations in English.  Like we did for foreign keys, we can see how long the query takes and read the explain plan.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">90791 rows in set (3.94 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations WHERE language_code = &#39;en&#39;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key           | key_len | ref   | rows    | Extra       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | NULL          | NULL    | NULL  | 1000111 | Using where |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<p>Adding an index to the <code>language_code</code> column should improve the query performance, so let’s do that and see the effect on our query:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">90791 rows in set (3.02 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations WHERE language_code = &#39;en&#39;;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key           | key_len | ref   | rows    | Extra       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<p>So the query now uses the index, and the time taken has gone from almost 4 seconds to just over 3.  That’s not nearly as big a performance gain as before, but why?  The answer is in the number of rows returned: 90791.  The index helps the database find the relevant rows quickly.  However, it still has to read those rows, and reading over 90,000 rows will always take a significant amount of time.</p>
<p>In a real app we’re unlikely to want to read all these rows at once, so let’s do another quick comparison limiting the query to the first 100 rows:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">Without the index:</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39; LIMIT 100;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">100 rows in set (1.32 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">And with the index:</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39; LIMIT 100;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">100 rows in set (0.01 sec)</span></span></code></pre>
<p>Much better.</p>
<h3 id="choosing-between-indexes">Choosing between indexes</h3>
<p>We’ve seen that by using an index and limiting the number of results we can quickly get the ‘first’ 100 English conversations.  But in this case ‘first’ doesn’t really mean anything.  When no order clause is specified, MySQL may appear to order its results by id, but this is just a coincidence and shouldn’t be relied on.  Let’s instead order our results by <code>created_at</code> to get the 100 most recent conversations.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39; ORDER BY created_at DESC;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">100 rows in set (4.42 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations WHERE language_code = &#39;en&#39; ORDER BY created_at DESC;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key           | key_len | ref   | rows    | Extra                       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where; using filesort |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<p>Even though this query uses our index and only returns 100 rows, it has still taken almost 4.5 seconds!  The reason for this terrible performance is hinted in the extra information in the explain plan: <code>using filesort</code>.  The database is reading all rows that match the condition (all 90791 of them), then using a filesort to order them before returning the first 100.</p>
<p>If we add an index on <code>created_at</code> and do the query again we get:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations WHERE language_code = &#39;en&#39; ORDER BY created_at DESC;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">100 rows in set (4.39 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations WHERE language_code = &#39;en&#39; ORDER BY created_at DESC;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key           | key_len | ref   | rows    | Extra                       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where; using filesort |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<p>It’s pretty much exactly the same - still almost 4.5 seconds.  This is because MySQL can only use one index per table in a query.  It has to choose between the index on <code>language_code</code> and the one on <code>created_at</code>, and in this case chooses the language code index.  We can force it to use our other index for comparison:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT * FROM conversations</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       USE INDEX(created_ix) WHERE language_code = &#39;en&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       ORDER BY created_at DESC LIMIT 100;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">100 rows in set (0.02 sec)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"></span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       USE INDEX(created_ix) WHERE language_code = &#39;en&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       ORDER BY created_at DESC LIMIT 100;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key           | key_len | ref   | rows    | Extra                       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | created_ix    | 8       | const | 9903411 | Using where                 |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+---------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<p>Using a trick stolen from <a href="http://m.onkey.org/2009/8/6/use-index-with-active-record-finders">Pratik Naik (in the comments of his article)</a> we can force the use of a particular index in rails with a special named scope, and perform our query:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-constant)">Conversation</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">named_scope :use_index</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">lambda</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">index</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  {:from </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{quoted_table_name}</span><span style="color:var(--astro-code-token-string-expression)"> USE INDEX(</span><span style="color:var(--astro-code-token-string-expression)">#{index}</span><span style="color:var(--astro-code-token-string-expression)">)&quot;</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Conversation</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">in_language(</span><span style="color:var(--astro-code-token-string-expression)">&#39;en&#39;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">use_index(</span><span style="color:var(--astro-code-token-string-expression)">&#39;created_ix&#39;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">all(:order </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;created_at desc&#39;</span><span style="color:var(--astro-code-color-text)">)</span></span></code></pre>
<p>But there is also another way - using indexing multiple columns.</p>
<h3 id="using-compound-indexes">Using compound indexes</h3>
<p>A compound index indexes across two or more columns.  When defining a compound index, the order of the columns is significant, as the database reduces the set of candidate rows by comparing the columns in turn.  So an index created with <code>add_index :conversations, [:language_code, :created_at]</code> will compare <code>language_code</code> first, then <code>created_at</code>.</p>
<p>Because of this, we need to take some care in choosing the order of our columns.  In general, the rule is to specify the most selective column first.  That is, the column with the most unique values.  So for our query, we’ll add the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">add_index :conversations</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> [:created_at</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :language_code]</span></span></code></pre>
<p>If we explain the query without forcing the index we find it is still efficient:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; EXPLAIN SELECT * FROM conversations</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       WHERE language_code = &#39;en&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       ORDER BY created_at DESC LIMIT 100;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+----------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| select_type | type | key            | key_len | ref   | rows    | Extra                       |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+----------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| SIMPLE      | ref  | lang_and_ca_ix |      48 | const |  640231 | Using where                 |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------+------+----------------+---------+-------+---------+-----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (0.00 sec)</span></span></code></pre>
<h3 id="a-technique-for-choosing-index-column-order">A technique for choosing index column order</h3>
<p>Sometimes it’s hard to know which order your columns should be in an index, but there’s an easy way to get a rough idea.  Rewrite the query, removing all conditions, and selecting <code>count(distinct column_to_index)</code> for each column.  So for our query, we’d do the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">mysql&gt; SELECT count(distinct language_code), count(distinct created_at)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       FROM conversations;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------------------------+----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">| count(distinct language_code) | count(distinct created_at) |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------------------------+----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">|                            21 |                     584089 |</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">+-------------------------------+----------------------------+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">1 row in set (1.90 sec)</span></span></code></pre>
<p>From this it’s clear that there are more distinct created_at values, so we probably want to index this column first.  Note though that I said probably.  When deciding on indexes, there are no hard and fast rules.  Instead, we need to measure and analyse the queries used in our particular app, to ensure we are using the best indexes.</p>
<p>The next (and last) article in the series will go through some more advanced techniques, including when not to add an index, and how to spot redundant indexes.</p>
          </li><li>
            <h2>
              <a href="/2009/08/tip-open-new-tab-in-osx-terminal">Tip: Open new tab in OS X Terminal</a>
            </h2>
            <p>Another simple shell function, this time just for OS X.</p>
<p>Usage is simple: <code>tab &lt;command&gt;</code> opens a new tab in Terminal, and runs the given command in the current working directory.  For example <code>tab script/server</code> would open a new tab and run <code>script/server</code>.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">tab</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">()</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  osascript </span><span style="color:var(--astro-code-token-keyword)">2&gt;</span><span style="color:var(--astro-code-color-text)">/dev/null </span><span style="color:var(--astro-code-token-keyword)">&lt;&lt;EOF</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">    tell application &quot;System Events&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">      tell process &quot;Terminal&quot; to keystroke &quot;t&quot; using command down</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">  	end</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">  	tell application &quot;Terminal&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">      activate</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">      do script with command &quot;cd $PWD; $*&quot; in window 1</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">    end tell</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">  EOF</span></span>
<span class="line"><span style="color:var(--astro-code-token-string)">}</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/09/quickly-list-missing-foreign-key-indexes">Quickly list missing foreign key indexes</a>
            </h2>
            <p>Run this code in a rails console to list foreign keys which aren’t indexed.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">c </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">ActiveRecord</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Base</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">connection</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">c</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">tables</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">t</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  columns </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> c</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">columns(t)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-color-text)">:name)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">x</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> x</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">ends_with?(</span><span style="color:var(--astro-code-token-string-expression)">&quot;_id&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">||</span><span style="color:var(--astro-code-color-text)"> x</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">ends_with(</span><span style="color:var(--astro-code-token-string-expression)">&quot;_type&quot;</span><span style="color:var(--astro-code-color-text)">))}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  indexed_columns </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> c</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">indexes(t)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-color-text)">:columns)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">flatten</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">uniq</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  unindexed </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> columns </span><span style="color:var(--astro-code-token-keyword)">-</span><span style="color:var(--astro-code-color-text)"> indexed_columns</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">unless</span><span style="color:var(--astro-code-color-text)"> unindexed</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">empty?</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{t}</span><span style="color:var(--astro-code-token-string-expression)">: </span><span style="color:var(--astro-code-token-string-expression)">#{unindexed</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-string-expression)">join(</span><span style="color:var(--astro-code-token-string-expression)">&quot;, &quot;</span><span style="color:var(--astro-code-token-string-expression)">)}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>This list will look something like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">attachments: parent_id, asset_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">domain_names: organisation_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">event_memberships: user_id, event_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">events: editor_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">group_actions: user_id, group_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">groups: user_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">icons: parent_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">invitations: sender_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">legacy_actions: item_upon_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">news_items: author_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">organisations: midas_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">pages: author_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">pending_event_memberships: invitation_id, event_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">resources: user_id, resourceable_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">subscriptions: subscribable_id, user_id</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">taggings: tag_id, taggable_id, user_id</span></span></code></pre>
<p>For each column in the list, ask yourself why you don’t need an index.</p>
<p><em>Update:</em> Andrew Coleman has <a href="http://penguincoder.org/pages/A_Slightly_Better_Way_To_Find_Missing_Foreign_Key_Indexes">added output in migration format</a>.  If you want to play around with it further, <a href="http://gist.github.com/191181">here’s the original code on gist</a>.</p>
          </li><li>
            <h2>
              <a href="/2009/09/tip-the-case-for-from-param">Tip: The case for from_param</a>
            </h2>
            <p>There’s one small method I add to every new rails project I work on:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Tomafro</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-function)">FromParam</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">from_param</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">param</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">first :conditions </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> { primary_key </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> param }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">ActiveRecord</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Base</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">extend</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">Tomafro</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">FromParam</span><span style="color:var(--astro-code-color-text)">)</span></span></code></pre>
<p>In my controllers, where you might use <code>Model.find(params[:id])</code> or <code>Model.find_by_id(params[:id)</code>, I use <code>Model.from_param(params[:id])</code> instead.</p>
<p>All three methods have almost the same behaviour, the only difference being the handling of missing records.  <code>find</code> throws a RecordNotFound, while <code>find_by_id</code> and <code>from_param</code> return nil.  So why use <code>from_param</code> over the others?</p>
<p>The answer comes when you want to change <code>to_param</code>, the method rails uses to turn a record into a parameter.  It’s a good principal (though often broken) not to expose database ids in urls.  An example might be to use a users nickname rather than their id in user urls, so <code>/users/12452</code> becomes <code>/users/tomafro</code>.  In rails this is easy to achieve, by overriding the <code>to_param</code> method:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">User</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">to_param</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">nickname</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Rails will automatically use this method when generating routes, so <code>users_path(@user)</code> will return <code>/users/tomafro</code> as we’d like.  If I was using <code>find</code> or <code>find_by_id</code> in my controllers, I’d then have to go through each one and change it to <code>find_by_nickname</code>.  Luckily though, I’ve used <code>from_param</code>, so whenever I override <code>to_param</code> I just have to remember to provide an equivalent implementation for <code>from_param</code>, and my controllers will work without modification:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">User</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.from_param</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">param</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">first :conditions </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> {:nickname </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> param}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">to_param</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">nickname</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>I’ve been doing this for years, but it’s hardly a new principle, to provide a <code>from</code> method for every <code>to</code> method.  There’s <a href="http://dev.rubyonrails.org/ticket/11505">even an old ticket on trac</a> asking for it, but it’s been considered too trivial to add.</p>
<p>I disagree - for me the value comes from having the method from the start, not when you need it.  Luckily it’s easy to add to my own projects.</p>
          </li><li>
            <h2>
              <a href="/2009/11/a-rails-template-for-gem-bundler">A rails template for gem bundler</a>
            </h2>
            <div class="update"><p><h3>Update 28th February 2010:</h3>
Bundler has changed a lot since I first wrote this template, so I’ve <a href="/2010/02/updated-rails-template-for-gem-bundler">written a new version</a>.  Please use the updated version rather than the one below.</p></div>
<p>Following Nick Quaranto’s article <a href="http://litanyagainstfear.com/blog/2009/10/14/gem-bundler-is-the-future/">‘Gem Bundler is the Future’</a>, I was inspired to try out <a href="http://github.com/wycats/bundler">bundler</a> on my latest rails project.  Previously, I’ve found rails’ own gem management a massive headache.  In contrast, using bundler has been a pleasure.</p>
<p>Getting it set up how I wanted took a fair bit of experimentation, so to make things easier both for me and the wider community, I’ve  made a rails template to do the hard work.</p>
<p>Give it a try by running the following. You should be up and running in a couple of minutes:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">rails -m http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)">project</span><span style="color:var(--astro-code-token-keyword)">&gt;</span></span></code></pre>
<p>That will give you a bundled project, ready for you to add your own gems.  Here’s what each step of the template actually does:</p>
<p>Gem bundler is itself a gem.  It can’t be used to manage itself, so to ensure that all environments use the same version, the first step is to install it right into the project:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">inside </span><span style="color:var(--astro-code-token-string-expression)">&#39;gems/bundler&#39;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  run </span><span style="color:var(--astro-code-token-string-expression)">&#39;git init&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  run </span><span style="color:var(--astro-code-token-string-expression)">&#39;git pull --depth 1 git://github.com/wycats/bundler.git&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  run </span><span style="color:var(--astro-code-token-string-expression)">&#39;rm -rf .git .gitignore&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Just having bundler installed is no good without any way to run it; a script is needed.  Once this is installed the local bundler can be run with <code>script/bundle &lt;options&gt;</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">file </span><span style="color:var(--astro-code-token-string-expression)">&#39;script/bundle&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">#!/usr/bin/env ruby</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">path = File.expand_path(File.join(File.dirname(__FILE__)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;..&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;gems/bundler/lib&quot;</span><span style="color:var(--astro-code-color-text)">))</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">$LOAD_PATH</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">unshift path</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;rubygems&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;rubygems/command&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;bundler&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;bundler/commands/bundle_command&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Gem</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Commands</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">BundleCommand</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">invoke(</span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-token-constant)">ARGV</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">strip</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">run </span><span style="color:var(--astro-code-token-string-expression)">&#39;chmod +x script/bundle&#39;</span></span></code></pre>
<p>Bundler uses Gemfiles to declare which gems are required in each environment.  This simple <code>Gemfile</code> includes rails in all environments, and ruby-debug in all environments other than production:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">file </span><span style="color:var(--astro-code-token-string-expression)">&#39;Gemfile&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">clear_sources</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">source &#39;http://gemcutter.org&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">disable_system_gems</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">bundle_path &#39;gems&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">gem &#39;rails&#39;, &#39;</span><span style="color:var(--astro-code-token-string-expression)">#{</span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">VERSION</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">STRING</span><span style="color:var(--astro-code-token-string-expression)">}</span><span style="color:var(--astro-code-token-string-expression)">&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">gem &#39;ruby-debug&#39;, :except =&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;production&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">strip</span></span></code></pre>
<p>Most of the files bundler will place in the <code>gem</code> path can be regenerated; they shouldn’t be added to the project repository.  The only things that should be added are the <code>.gem</code> files themselves, and the local copy of bundler.  All the rest should be ignored:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">append_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;.gitignore&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">gems/*</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">!gems/cache</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">!gems/bundler}</span></span></code></pre>
<p>The bundle script needs to be run for the first time:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">run </span><span style="color:var(--astro-code-token-string-expression)">&#39;script/bundle&#39;</span></span></code></pre>
<p>Finally rails needs to be modified to ensure the bundler environment is loaded.  This is done it two parts.  First, a preinitializer is added to load the bundler’s environment file before anything else:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">append_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;/config/preinitializer.rb&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">require File.expand_path(File.join(File.dirname(__FILE__)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;..&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;gems&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;environment&quot;</span><span style="color:var(--astro-code-color-text)">))</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>Second, rails initialization process is hijacked to require the correct bundler environment:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">gsub_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;config/environment.rb&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;require File.join(File.dirname(__FILE__), &#39;boot&#39;)&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">require File.join(File.dirname(__FILE__)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;boot&#39;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)"># Hijack rails initializer to load the bundler gem environment before loading the rails environment.</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Initializer</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">module_eval </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">alias</span><span style="color:var(--astro-code-color-text)"> load_environment_without_bundler load_environment</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">load_environment</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">Bundler</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">require_env configuration</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">environment</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    load_environment_without_bundler</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>And that’s it.  The project is now fully bundled.  More gems can be added to the <code>Gemfile</code> and pulled into the project with <code>script/bundle</code>.</p>
          </li><li>
            <h2>
              <a href="/2009/11/building-gems-from-a-rails-branch">Building rails gems from the 2-3-stable branch</a>
            </h2>
            <p>For the latest application I’ve been working on, I wanted to use <a href="http://github.com/NZKoz/rails_xss/">Michael Koziarski’s rails_xss plugin</a>, to turn default escaping on in my erb templates.  I’m also using <a href="http://github.com/wycats/bundler/">wycats gem bundler</a> to manage gems and their dependencies, including rails.</p>
<p>This posed a problem: xss_rails requires changes made in rails 2-3-stable branch, but not yet released in a gem (though they will be included in 2.3.5).</p>
<p>The solution was obvious: build my own gems, and get bundler to use them.  Luckily, rails makes this an easy process.</p>
<p>First, clone rails from github, and change to the 2-3-stable branch:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">git clone git://github.com/rails/rails.git</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> rails</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">git co -b 2-3-stable origin/2-3-stable</span></span></code></pre>
<p>Next, we need to build the gems.  Rails currently doesn’t seem to have a Raketask to build all its constituent projects (though I’m planning a patch to include one), so you have to build each one in turn:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> actionmailer</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ../actionpack</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ../activerecord</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ../activeresource</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ../activesupport</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ../railties</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake gem PKG_BUILD=1</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> ..</span></span></code></pre>
<p>The key is the <code>PKG_BUILD</code> variable.  It appends a suffix to the rails version, so rather than building 2.3.4 (the version I checked out), it will build 2.3.4.1.  If I decided to update my gems, I’d use PKG_BUILD=2, then 3 and so on.</p>
<p>Finally, once all these gems are built, it’s simply a case of finding them and using them.  For gem bundler, this means placing them in the cache and updating the Gemfile to look for rails ‘2.3.4.1’.  The gems are all built in pkg folders in their respective subprojects, so to copy them all somewhere else you can run:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">cp </span><span style="color:var(--astro-code-token-keyword)">**</span><span style="color:var(--astro-code-color-text)">/pkg/</span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)">.gem </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)">project-folder</span><span style="color:var(--astro-code-token-keyword)">&gt;</span><span style="color:var(--astro-code-color-text)">/gems/cache</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2009/11/zoom-keyboard-shortcut-for-os-x">Tip: Zoom keyboard shortcut for OS X</a>
            </h2>
            <p>In the Terminal run:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">defaults write NSGlobalDomain NSUserKeyEquivalents </span><span style="color:var(--astro-code-token-string-expression)">&#39;{&quot;Zoom&quot; = &quot;@^Z&quot;; &quot;Zoom Window&quot; = &quot;@^Z&quot;; }&#39;</span></span></code></pre>
<p>Quit and relaunch your applications, and <span class="osx-shortcut">⌃⌘Z</span> should zoom and unzoom.</p>
<p>Stolen from <a href="http://www.macosxhints.com/article.php?story=20051227001809626">macoshints.com</a>, posted here for my own benefit.</p>
          </li><li>
            <h2>
              <a href="/2009/11/taking-screenshots-of-web-pages-with-macruby">Taking screenshots of web pages with macruby</a>
            </h2>
            <p>Whilst playing around with the very exciting <a href="http://macruby.org">macruby</a> last weekend, I thought I’d try building a web page screenshot grabber, based on <a href="http://www.bencurtis.com/?p=128">Ben Curtis’ code</a>.  The code was very easy to change translate from <code>rubycocoa</code>, looks cleaner and seems to work really well:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">framework </span><span style="color:var(--astro-code-token-string-expression)">&#39;Cocoa&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">framework </span><span style="color:var(--astro-code-token-string-expression)">&#39;WebKit&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Snapper</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">attr_accessor</span><span style="color:var(--astro-code-color-text)"> :options</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :view</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :window</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">initialize</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @options </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> options</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    initialize_view</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">save</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">url</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">file</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setFrameLoadDelegate(self)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Tell the webView what URL to load.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    frame </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">mainFrame</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    req </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">NSURLRequest</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">requestWithURL(</span><span style="color:var(--astro-code-token-constant)">NSURL</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">URLWithString</span><span style="color:var(--astro-code-color-text)">(url))</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">		frame</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">loadRequest req</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">while</span><span style="color:var(--astro-code-color-text)"> view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">isLoading  </span><span style="color:var(--astro-code-token-keyword)">&amp;&amp;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">timed_out?</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-constant)">NSRunLoop</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">currentRunLoop</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">runUntilDate </span><span style="color:var(--astro-code-token-constant)">NSDate</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">date</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> @failedLoading</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Failed to load page at: </span><span style="color:var(--astro-code-token-string-expression)">#{url}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">mainFrame</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">frameView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">documentView</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">window</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setContentSize(docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">bounds</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">size)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setFrame(view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">bounds)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setNeedsDisplay(</span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">displayIfNeeded</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">lockFocus</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      bitmap </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">NSBitmapImageRep</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">alloc</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">initWithFocusedViewRect(docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">bounds)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      docView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">unlockFocus</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-comment)"># Write the bitmap to a file as a PNG</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      representation </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> bitmap</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">representationUsingType(</span><span style="color:var(--astro-code-token-constant)">NSPNGFileType</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> properties:</span><span style="color:var(--astro-code-token-constant)">nil</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      representation</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">writeToFile(file</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> atomically:</span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      bitmap</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">release</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">webView</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">view</span><span style="color:var(--astro-code-color-text)">, didFailLoadWithError:error, forFrame:frame)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @failedLoading </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">webView</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">view</span><span style="color:var(--astro-code-color-text)">, didFailProvisionalLoadWithError:error, forFrame:frame)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @failedLoading </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">initialize_view</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">NSApplication</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">sharedApplication</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">view </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">WebView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">alloc</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">initWithFrame([</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1024</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">600</span><span style="color:var(--astro-code-color-text)">])</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">window </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">NSWindow</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">alloc</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">initWithContentRect([</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1024</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">600</span><span style="color:var(--astro-code-color-text)">]</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      styleMask:</span><span style="color:var(--astro-code-token-constant)">NSBorderlessWindowMask</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> backing:</span><span style="color:var(--astro-code-token-constant)">NSBackingStoreBuffered</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> defer:</span><span style="color:var(--astro-code-token-constant)">false</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    window</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setContentView(view)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Use the screen stylesheet, rather than the print one.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setMediaStyle(</span><span style="color:var(--astro-code-token-string-expression)">&#39;screen&#39;</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Set the user agent to Safari, to ensure we get back the exactly the same content as</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># if we browsed directly to the page</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setCustomUserAgent </span><span style="color:var(--astro-code-token-string-expression)">&#39;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_2; en-us)&#39;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-string-expression)">&#39;AppleWebKit/531.21.8 (KHTML, like Gecko) Version/4.0.4 Safari/531.21.10&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Make sure we don&#39;t save any of the prefs that we change.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">preferences</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setAutosaves(</span><span style="color:var(--astro-code-token-constant)">false</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Set some useful options.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">preferences</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setShouldPrintBackgrounds(</span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">preferences</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setJavaScriptCanOpenWindowsAutomatically(</span><span style="color:var(--astro-code-token-constant)">false</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">preferences</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setAllowsAnimatedImages(</span><span style="color:var(--astro-code-token-constant)">false</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-comment)"># Make sure we don&#39;t get a scroll bar.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    view</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">mainFrame</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">frameView</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setAllowsScrolling(</span><span style="color:var(--astro-code-token-constant)">false</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">timed_out?</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @start </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Time</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">now</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    (</span><span style="color:var(--astro-code-token-constant)">Time</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">now</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_i </span><span style="color:var(--astro-code-token-keyword)">-</span><span style="color:var(--astro-code-color-text)"> @start</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_i) </span><span style="color:var(--astro-code-token-keyword)">&gt;</span><span style="color:var(--astro-code-color-text)"> (options[:timeout] </span><span style="color:var(--astro-code-token-keyword)">||</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">30</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>To use:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">macruby </span><span style="color:var(--astro-code-token-keyword)">-</span><span style="color:var(--astro-code-color-text)">r snapper</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">rb </span><span style="color:var(--astro-code-token-keyword)">-</span><span style="color:var(--astro-code-color-text)">e </span><span style="color:var(--astro-code-token-string-expression)">&quot;Snapper.new.save(&#39;http://tomafro.net&#39;, &#39;tomafro.net.png&#39;)&quot;</span></span></code></pre>
<p>The next step is to add some command line options, then try compilation and deployment with <code>macrubyc</code> and <code>macruby_deploy</code></p>
          </li><li>
            <h2>
              <a href="/2010/01/tip-relative-paths-with-file-expand-path">Tip: Relative paths with File.expand_path</a>
            </h2>
            <p>You probably know about the <code>__FILE__</code> magic constant.  It holds the filename of the currently executing ruby source file, relative to the execution directory.  So with the following saved as <code>/code/examples/path_example.rb</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> __FILE__</span></span></code></pre>
<p>Running this file from the <code>/code</code> folder will output <code>examples/path_example.rb</code></p>
<p>This is often used to load files on paths relative to the current file.  The way I’ve used it before is like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">config_path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">expand_path(</span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">join(</span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">dirname(__FILE__)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;config.yml&quot;</span><span style="color:var(--astro-code-color-text)">))</span></span></code></pre>
<p>This works, but it’s a bit clunky.</p>
<p>What I didn’t realise until reading the rails source code the other day, is that <code>File.expand_path</code> can take a second argument - a starting directory.  Also, this argument doesn’t actually have to be a path to a directory, it also accepts a path to a file.  With this knowledge we can shorten the above to the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">config_path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">File</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">expand_path(</span><span style="color:var(--astro-code-token-string-expression)">&quot;../config.yml&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> __FILE__)</span></span></code></pre>
<p>Much simpler.</p>
          </li><li>
            <h2>
              <a href="/2010/01/how-to-use-rails3-gems-now">How to easily use Rails 3 now</a>
            </h2>
            <div class="update"><p><h3>Update 10th February 2010:</h3>
The instructions below were useful earlier in the development cycle.  Now the <a href="http://weblog.rubyonrails.org/2010/2/5/rails-3-0-beta-release">beta gem has been released</a>, the process is much easier:</p><pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">gem uninstall bundler</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">gem install tzinfo builder memcache-client rack rack-test rack-mount</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">gem install erubis mail text-format thor bundler i18n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">gem install rails --pre</span></span></code></pre></div>
<p>Now that rails 3 is getting closer to release, I wanted to start playing around with it.  I’ve seen a few articles on getting it up and running, but they all seemed a little bit complicated.  To use rails 2.3.5 before its release, I just built the gems myself and installed them.  It turns out you can easily do the same with rails 3.</p>
<p>First, install rails main dependencies:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">gem install rake rack bundler</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">gem install arel --version 0.2.pre</span></span></code></pre>
<p>Next, get the latest rails code from github, and install the rails gems.  There may be a few errors you can safely ignore:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">git clone git://github.com/rails/rails.git</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> rails</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">rake install</span></span></code></pre>
<p>And bang, you can start your first rails 3 project:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">rails </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/apps/playground/rails3</span></span></code></pre>
<p>Your existing projects shouldn’t be affected as rails is installed as a prerelease gem, but to be safe I’d recommend a tool like <a href="http://rvm.beginrescueend.com/">rvm</a> to switch to a clean set of gems.</p>
          </li><li>
            <h2>
              <a href="/2010/02/rails-3-direct-column-reader">Rails 3 direct column reader</a>
            </h2>
            <p>Whilst trying to get my head around <a href="http://github.com/brynary/arel">arel</a> and it’s relationship to ActiveRecord in rails 3, I’ve updated the simple ColumnReader class I <a href="http://tomafro.net/2009/05/read-active-record-columns-directly-from-the-class">introduced last year</a>.  It lets you read the (correctly cast) column values for an ActiveRecord class, without the overhead of instantiating each object.</p>
<p>Here’s the updated code:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ColumnReader</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">column_reader</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">column_name</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    name </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> options</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">delete(:as) </span><span style="color:var(--astro-code-token-keyword)">||</span><span style="color:var(--astro-code-color-text)"> column_name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_s</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">pluralize</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    column </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> columns_hash[column_name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_s]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">module_eval </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">      def self.</span><span style="color:var(--astro-code-token-string-expression)">#{name}</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">        query = scoped.arel.project(arel_table[:</span><span style="color:var(--astro-code-token-string-expression)">#{column_name}</span><span style="color:var(--astro-code-token-string-expression)">]</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        connection</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">select_all(query</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_sql)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">collect </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          v </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> value</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">values</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">first</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          </span><span style="color:var(--astro-code-token-comment)">#{column.type_cast_code(&#39;v&#39;)}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">ActiveRecord</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Base</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">extend</span><span style="color:var(--astro-code-color-text)">(self)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>The code isn’t that different, though using <code>scoped</code> over <code>construct_finder_sql</code> feels a lot nicer.  If you’ve got suggestions for improvement <a href="http://gist.github.com/301420">gist away</a>.</p>
<p>Usage is similar to before, only using the new rails 3 syntax:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Animal</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveRecord::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  column_reader </span><span style="color:var(--astro-code-token-string-expression)">&#39;id&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  column_reader </span><span style="color:var(--astro-code-token-string-expression)">&#39;name&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  named_scope :dangerous</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :conditions </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> {:carnivorous </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;, &#39;Zebra&#39;, &#39;Gazelle&#39;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">limit(</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;] (Normal finder options supported)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">dangerous</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">names</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;] (Scoping respected)</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Animal</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">ids</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">#=&gt; [1, 2, 3] (Values cast correctly)</span></span></code></pre>
<p>I’m still not entirely convinced of the value of this helper, so if you find a good use <a href="http://twitter.com/tomafro">tweet me</a>.  Enjoy!</p>
          </li><li>
            <h2>
              <a href="/2010/02/updated-rails-template-for-bundler">An updated rails template for gem bundler</a>
            </h2>
            <div class="update"><p><h3>Update 8th February 2011:</h3>
Bundler has changed a lot since I wrote these instructions.  Use them at your own risk!</p></div>
<p>A few months ago I wrote <a href="http://tomafro.net/2009/11/a-rails-template-for-gem-bundler">a rails template for gem bundler</a>. Since then, bundler has changed a lot, and my template no longer works. <a href="http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb">Here then is an updated version</a>, based on <a href="http://gist.github.com/302406">this gist</a> from <a href="http://arko.net/">Andre Arko</a>.  Using it, you should be able to get a rails 2.3.5 project working with bundler in less than 5 minutes.</p>
<p>The first step is to install the latest bundler.  At the time of writing, this was 0.9.9.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">gem install bundler</span></span></code></pre>
<p>Now you should be able to run the template, either on a new project, or on an existing rails 2.3.5 project.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">rails -m http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)">project</span><span style="color:var(--astro-code-token-keyword)">&gt;</span></span></code></pre>
<p>On a fresh project, that should be all you need to do.  On an existing that used an older version of bundler, you’ll need to remove the old hooks in <code>config/preinitializer.rb</code> and <code>config/environment.rb</code>, and the <code>gems</code> folder.</p>
<h3>Explaining the template, step by step</h3>
<p>The first step creates the project <code>Gemfile</code>, with rails available in all environments, and ruby-debug included in development.  If the project has other gems, they should be added here, rather than using rails own <code>config.gem</code> mechanism.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">file </span><span style="color:var(--astro-code-token-string-expression)">&#39;Gemfile&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">source &#39;http://rubygems.org&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">gem &#39;rails&#39;, &#39;</span><span style="color:var(--astro-code-token-string-expression)">#{</span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">VERSION</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">STRING</span><span style="color:var(--astro-code-token-string-expression)">}</span><span style="color:var(--astro-code-token-string-expression)">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">group :development do</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  gem &#39;ruby-debug&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">strip</span></span></code></pre>
<p>The next step is get bundler to load correctly.  This is done in two stages.  First, in <code>config\preinitializer.rb</code> bundler needs to be setup.  This adds all the bundled gems to the ruby load path, but doesn’t initialise them.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">append_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;/config/preinitializer.rb&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">begin</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  # Require the preresolved locked set of gems.</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  require File.expand_path(&#39;../../.bundle/environment&#39;, __FILE__)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">rescue</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">LoadError</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-comment)"># Fallback on doing the resolve at runtime.</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;rubygems&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;bundler&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Bundler</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">VERSION</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;0.9.5&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">raise</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">RuntimeError</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Bundler incompatible.\n&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-string-expression)">&quot;Your bundler version is incompatible with Rails 2.3 and an unlocked bundle.\n&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-string-expression)">&quot;Run `gem install bundler` to upgrade or `bundle lock` to lock.&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-constant)">Bundler</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">setup</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">strip</span></span></code></pre>
<p>Second, the rails boot process is modified to start the bundler environment.  This ‘requires’ all gems in the bundle, letting them run initialisation code.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">gsub_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;config/boot.rb&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Rails.boot!&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">class Rails::Boot</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)"> def run</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   load_initializer</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   extend_environment</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   Rails::Initializer.run(:set_load_path)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">extend_environment</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">   </span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Initializer</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class_eval </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">     old_load </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> instance_method(:load_environment)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">     define_method(:load_environment) </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       </span><span style="color:var(--astro-code-token-constant)">Bundler</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">require :default</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">env</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       old_load</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">bind(self)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">     </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">   </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">boot!</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>All that’s left now is a little cleaning up.  The <code>.bundle</code> folder should never be checked into the code repository as it holds machine-local configuration, so it’s added to <code>.gitignore</code>.  Finally, <code>bundle install</code> is run to fetch the bundled gems.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">append_file </span><span style="color:var(--astro-code-token-string-expression)">&#39;/.gitignore&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">%{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">/.bundle</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">run </span><span style="color:var(--astro-code-token-string-expression)">&#39;bundle install&#39;</span></span></code></pre>
<p>And that’s it.  I hope you find it useful.</p>
          </li><li>
            <h2>
              <a href="/2011/02/rails-3-column-reader-tweak">A home for my Active Record column reader</a>
            </h2>
            <p><a href="http://twitter.com/kraykray">@kraykray</a> was nice enough to let me know that Rails 3.03 had broken my column-reader code.</p>
<p>I’ve always seen it as a toy rather than a serious project, but getting a bug report made me re-evaluate.  If people are using it, even a tiny piece of code like this deserves a proper home.</p>
<p>So here it is, as both <a href="https://github.com/tomafro/rails-activerecord-columnreader">a github repository</a> and <a href="http://rubygems.org/gems/activerecord-column-reader">a gem</a>.  Enjoy!</p>
          </li><li>
            <h2>
              <a href="/2011/02/experimental-mongo-instrumentation">Experimental Mongo instrumentation (for Rails 3)</a>
            </h2>
            <div class="update"><p>Update: Changed to instrument methods on the Mongo::Connection</p></div>
<p>One of our latest rails projects uses <a href="http://mongodb.org">Mongo</a> as a backend.  We’re just starting to get some traffic, and as we do, we’re monitoring the logs for slow requests.  When using ActiveRecord, rails splits out the recorded request time like so:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">    Completed 200 OK </span><span style="color:var(--astro-code-token-keyword)">in</span><span style="color:var(--astro-code-color-text)"> 6ms (Views 370.5ms </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-color-text)"> ActiveRecord: 2.3ms)</span></span></code></pre>
<p>We wanted to do the same for our Mongo accesses, just to give a rough idea as to what our requests were doing.  Luckily Rails 3 makes this relatively straightforward, providing hooks to instrument methods, subscribe to log messages and add information to the request log.  Here, then, is my first stab (mainly harvested from ActiveRecord):</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Mongo</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Instrumentation</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.instrument</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">clazz</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-token-parameter)">methods</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      clazz</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">module_eval </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        methods</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">m</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          class_eval </span><span style="color:var(--astro-code-token-string-expression)">%{def </span><span style="color:var(--astro-code-token-string-expression)">#{m}</span><span style="color:var(--astro-code-token-string-expression)">_with_instrumentation(*args, &amp;block)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            </span><span style="color:var(--astro-code-token-constant)">ActiveSupport</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Notifications</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">instrumenter</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">instrument </span><span style="color:var(--astro-code-token-string-expression)">&quot;mongo.mongo&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :name </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-string-expression)">#{m}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">              </span><span style="color:var(--astro-code-token-comment)">#{m}_without_instrumentation(*args, &amp;block)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          alias_method_chain m</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :instrumentation</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Railtie</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Rails::Railtie</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      initializer </span><span style="color:var(--astro-code-token-string-expression)">&quot;mongo.instrumentation&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">app</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Instrumentation</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">instrument </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Connection</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :send_message</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :send_message_with_safe_check</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :receive_message</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-constant)">ActiveSupport</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">on_load(:action_controller) </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          </span><span style="color:var(--astro-code-token-keyword)">include</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Instrumentation</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">ControllerRuntime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Instrumentation</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">LogSubscriber</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">attach_to :mongo</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ControllerRuntime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">extend</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">ActiveSupport</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Concern</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">protected</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      attr_internal :mongo_runtime</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">cleanup_view_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        mongo_rt_before_render </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Instrumentation</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">LogSubscriber</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">reset_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        runtime </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">super</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        mongo_rt_after_render </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Mongo</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">Instrumentation</span><span style="color:var(--astro-code-token-punctuation)">::</span><span style="color:var(--astro-code-token-constant)">LogSubscriber</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">reset_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">mongo_runtime </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> mongo_rt_before_render </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> mongo_rt_after_render</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        runtime </span><span style="color:var(--astro-code-token-keyword)">-</span><span style="color:var(--astro-code-color-text)"> mongo_rt_after_render</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">append_info_to_payload</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">payload</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">super</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        payload[:mongo_runtime] </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> mongo_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">module</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ClassMethods</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">log_process_action</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">payload</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          messages</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> mongo_runtime </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">super</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> payload[:mongo_runtime]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          messages </span><span style="color:var(--astro-code-token-keyword)">&lt;&lt;</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-string-expression)">&quot;Mongo: %.1fms&quot;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> mongo_runtime</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">to_f) </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> mongo_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">          messages</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LogSubscriber</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ActiveSupport::LogSubscriber</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.runtime=</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">value</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-constant)">Thread</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">current[</span><span style="color:var(--astro-code-token-string-expression)">&quot;mongo_mongo_runtime&quot;</span><span style="color:var(--astro-code-color-text)">] </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> value</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        </span><span style="color:var(--astro-code-token-constant)">Thread</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">current[</span><span style="color:var(--astro-code-token-string-expression)">&quot;mongo_mongo_runtime&quot;</span><span style="color:var(--astro-code-color-text)">] </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">self.reset_runtime</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        rt</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">runtime </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> runtime</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        rt</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">mongo</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">event</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">runtime </span><span style="color:var(--astro-code-token-keyword)">+=</span><span style="color:var(--astro-code-color-text)"> event</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">duration</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>It looks complicated, but it’s actually pretty simple.  Data access methods in <strike><code>Mongo::DB</code> and <code>Mongo::Collection</code></strike> <code>Mongo::Connection</code> are hijacked and surrounded by an <code>ActiveSupport::Notifications.instrumenter.instrument</code> block.  This triggers events which are listened to by the <code>LogSubscriber</code>, summing the total time spent in Mongo.  The <code>ControllerRuntime</code> then collects this count to be displayed, and resets the sum to zero ready for the next request.  The output looks like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">    Completed 200 OK </span><span style="color:var(--astro-code-token-keyword)">in</span><span style="color:var(--astro-code-color-text)"> 838ms (Views: 370.5ms </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-color-text)"> ActiveRecord: 2.3ms </span><span style="color:var(--astro-code-token-keyword)">|</span><span style="color:var(--astro-code-color-text)"> Mongo: 441.5ms)</span></span></code></pre>
<p>It’s just a first stab, so any comments and improvements are more then welcome.  It’s <a href="https://gist.github.com/833444">here on gist</a> so please fork away.</p>
          </li><li>
            <h2>
              <a href="/2011/02/rails-mongo-instrumentation-gem">Mongo instrumentation released as a gem</a>
            </h2>
            <p>Enough people seemed to comment and like the mongo instrumentation code I wrote about yesterday that I’ve packaged it up and released it as a gem.</p>
<p>The <a href="http://rubygems.org/gems/mongo-rails-instrumentation">mongo-rails-instrumentation</a> gem is available on rubygems, and the code is <a href="https://github.com/tomafro/mongo-rails-instrumentation">up on github</a>.</p>
<p>Adding it to a project is simple, just put the following in your <code>Gemfile</code>, run <code>bundle install</code> and restart your app.</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">    gem </span><span style="color:var(--astro-code-token-string-expression)">&#39;mongo-rails-instrumentation&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;~&gt;0.1&#39;</span></span></code></pre>
<p>Please add any suggestions, improvements and comments to the code in github.  I hope people find it useful.</p>
          </li><li>
            <h2>
              <a href="/2011/03/hashblue-opens-for-business">#blue opens for business</a>
            </h2>
            <p>If you’re an <a href="http://o2.co.uk">O2</a> customer based in the UK, you might be interested that <a href="https://hashblue.com">#blue</a>, a project <a href="http://gofreerange.com">we’ve built</a>, has recently (re)opened for business.  It’s a soft launch, but feel free to tell your friends.</p>
<p><a href="https://hashblue.com">#blue</a> gets copies of every SMS message you send or receive, and makes them available to you on the web.  You can search your messages, read whole conversations, and even reply, all from the comfort of your browser.</p>
<div class="screenshot"><img src="/images/20110303-hashblue-messages.png"/></div>
<p>As well as a nice-looking web UI, there’s also <a href="https://api.hashblue.com">an API</a> that allows other apps to read and manipulate your messages and contacts (once you give them permission). Think automatic posting to twitter, or showing new messages as alerts on your desktop.  The possibilities are endless.</p>
<div class="screenshot"><img src="/images/20110303-hashblue-api.png"/></div>
<p>Oh, and it’s all free.  All you need is an <a href="http://o2.co.uk">O2</a> phone.</p>
<p>If you think it sounds interesting, <a href="https://hashblue.com/">ask for a beta request</a>.  You should get an invitation very quickly.  Once on board, please send me any suggestions and feedback.  It’s going to be interesting to see where we can take this project.</p>
          </li><li>
            <h2>
              <a href="/2011/08/presenting-the-hashblue-api">Presenting the #blue api</a>
            </h2>
            <p>In building <a href="https://hashblue.com">#blue</a> (sign up now!), one of the problems we faced was how to build <code>json</code> data in response to requests to <a href="https://api.hashblue.com">our API</a>.  The typical rails solution would be to override <code>#as_json</code> in a model class, then write a controller like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactsController</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApiController</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  responds_to :json</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">show</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    respond_with </span><span style="color:var(--astro-code-token-constant)">Contact</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">find(params[:id])</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>I always prefer to keep my controllers as skinny as possible, so this looks like a great solution.  The <code>respond_with</code> call takes care of converting the message to json and responding with the right <code>Content-Type</code>, all in a simple call.  However it has a number of problems and disadvantages.</p>
<p>The biggest issue for our API is that rather than expose the <code>id</code> of each model, we’ve tried to encourage the use of the <code>uri</code> instead.  So the <code>json</code> returned for a single contact (for example) looks like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">{</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-string-expression)">&quot;contact&quot;</span><span style="color:var(--astro-code-color-text)">: {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;uri&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;https://api.example.com/contacts/ccpwjc&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;name&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;George&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;email&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;george@handmade.org&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;msisdn&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;447897897899&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;phone_number&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;07897897899&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-string-expression)">&quot;messages&quot;</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;https://api.example.com/contacts/ccpwjc/messages&quot;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>It doesn’t just have a <code>uri</code> for the actual contact, but also for the messages belonging to that contact (and yes, I regret not calling that attribute <code>messages_uri</code>).  Models can’t generate uris, and shouldn’t really be aware of them, so overriding <code>#as_json</code> doesn’t work.  In any case, the json structure is really presentation logic, not business logic.  It doesn’t belong in the model.</p>
<h3 id="presenting-a-single-model">Presenting a single model</h3>
<p>The solution we’ve used is to build a presenter for each model, solely responsible for building the json.  Here’s an example for a contact:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactPresenter</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">include</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">application</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">routes</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">url_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">attr_accessor</span><span style="color:var(--astro-code-color-text)"> :controller</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  delegate :params</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :url_options</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :to </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :controller</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  delegate :errors</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :to </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">initialize</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">controller</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">subject</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @controller </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> controller</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @subject </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> subject</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">as_json</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    {:contact </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :uri </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> uri</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :email </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">email</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :name </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">name</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :msisdn </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">msisdn</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :phone_number </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">phone_number</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :messages </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> api_contact_messages_url(:contact_id </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">id)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">uri</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    api_contact_url(:id </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">id)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>It’s now simple to rewrite our controller to use the new presenter:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactsController</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApiController</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  responds_to :json</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">show</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    respond_with </span><span style="color:var(--astro-code-token-constant)">ContactPresenter</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)">(self</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Contact</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">find(params[:id]))</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<h3 id="presenting-pages-of-models">Presenting pages of models</h3>
<p>The presenter above works well for a single model, but many of our API calls return a page of results.  The <a href="https://api.hashblue.com/doc/GET%3Acontacts">/contacts</a> for example returns all the contacts belonging to a user (of which there may be hundreds).  Luckily it’s simple to adapt this pattern to present pages like this.  First, we change our original <code>#as_json</code> method slightly:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">as_json</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> options[:partial]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :uri </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> uri</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :email </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">email</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :name </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">name</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :msisdn </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">msisdn</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :phone_number </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">phone_number</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :messages </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> api_contact_messages_url(:contact_id </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">id)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    {:contact </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> as_json(:partial </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">)}</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>This change allows us to call as_json with the options <code>:partial</code>.  With the option, a hash of data is returned.  Without, the same hash is returned, wrapped in another hash.</p>
<p>Next, add a page presenter:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactPagePresenter</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">include</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Rails</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">application</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">routes</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">url_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">attr_accessor</span><span style="color:var(--astro-code-color-text)"> :controller</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  delegate :params</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :url_options</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :to </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :controller</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  delegate :errors</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :to </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :subject</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">initialize</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">controller</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">subject</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @controller </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> controller</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @subject </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> subject</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">as_json</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    contacts </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">map {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">o</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">ContactPresenter</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)">(controller</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> o)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">as_json(:partial </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">true</span><span style="color:var(--astro-code-color-text)">) }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    {:contacts </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> contacts}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">tap </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">result</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">previous_page</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        result[:previous_page_uri] </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> contacts_url(subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">previous_page)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">next_page</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        result[:next_page_uri] </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> contacts_url(subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">next_page)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Finally, we can add an index action using this presenter:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactsController</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApiController</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  responds_to :json</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">index</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    respond_with </span><span style="color:var(--astro-code-token-constant)">ContactPagePresenter</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)">(self</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Contact</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">paginate(</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :page </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> params[:page]</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      :per_page </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">50</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    )</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<h3 id="refactoring-common-logic">Refactoring common logic</h3>
<p>The code above is a very much simplified version of what we do in <a href="https://hashblue.com">#blue</a>.  We have many controllers, and several different models, so in our actual code we’ve abstracted out as much common logic as possible.  In reality, our contacts controller looks more like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ContactsController</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApiController</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  before_filter :find_contact</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :only </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [:show</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :update]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">show</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    present @contact</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">index</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    present_page_of current_account</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">contacts</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">create</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @contact </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> current_account</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">contacts</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">build(attributes)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @contact</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">save</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    present @contact</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">update</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @contact</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">update_attributes(attributes)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    present @contact</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">find_contact</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    @contact </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> current_account</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">contacts</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">where(:_id </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> params[:id])</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">first</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    head :status </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> :not_found </span><span style="color:var(--astro-code-token-keyword)">unless</span><span style="color:var(--astro-code-color-text)"> @contact</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>I think the code looks pretty clean.  The clever stuff happens in the <code>#present</code> and <code>#present_page_of</code> methods, defined in the superclass:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApiController</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">ApplicationController::Base</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">protected</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">present</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">instance</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    presenter </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> presenter_class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)">(self</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> instance)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    options[:location] </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> presenter</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">uri </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> request</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">post? </span><span style="color:var(--astro-code-token-keyword)">&amp;&amp;</span><span style="color:var(--astro-code-color-text)"> subject</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">errors</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">empty?</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    respond_with presenter</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> options</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">present_page_of</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">collection</span><span style="color:var(--astro-code-color-text)">, </span><span style="color:var(--astro-code-token-parameter)">options</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {})</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    presenter </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> page_presenter_class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)">(self</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> page_of(collection))</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    respond_with presenter</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> options</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">page_of</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">collection</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    collection</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">paginate(:page </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> params[:page]</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :per_page </span><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">50</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">presenter_class</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    (self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">gsub!(</span><span style="color:var(--astro-code-token-string-expression)">&quot;Controller&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;&quot;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">singularize </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Presenter&quot;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">constantize</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">page_presenter_class</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    (self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">name</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">gsub!(</span><span style="color:var(--astro-code-token-string-expression)">&quot;Controller&quot;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;&quot;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">singularize </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;PagePresenter&quot;</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">constantize</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>The <code>#present</code> and <code>#present_page_of</code> methods handle determining the correct presenter to us, as well as paginating the collection where required.  They still use rails build in <code>#respond_with</code> method, which helps provide the correct response headers for each request.  As the ContactPresenter delegates <code>#errors</code> to its subject, if there are validation errors, <code>#respond_with</code> correctly returns a 422.</p>
<p>One further motivation for this pattern (other than moving presentation logic out of the model) is that should we want to release a new version of our API, we’ll be able to get a lot of the way there simply by swapping which presenter is used.  We started using this code about 8 months ago, and I’m still pretty happy with it.  I hope you find something useful in it too.</p>
<p>Any comments or suggestions, please get in touch with me <a href="http://twitter.com/tomafro">on twitter</a>.</p>
          </li><li>
            <h2>
              <a href="/2011/09/tip-automatic-bundle-exec-for-rake-and-more">Tip: Automatic bundle exec for rake and other gems</a>
            </h2>
            <p>It’s irritating to run gem commands like <code>rake</code>, <code>cap</code>, <code>rspec</code> and others, only to find they needed to be executed via <code>bundle exec</code>.  As a simple solution, I use a simple zsh function, combined with aliases for commonly used commands.</p>
<p>Here’s the function (which I’ve named <code>be</code>):</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> [[ </span><span style="color:var(--astro-code-token-keyword)">-a</span><span style="color:var(--astro-code-color-text)"> Gemfile ]]</span><span style="color:var(--astro-code-token-keyword)">;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">then</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  bundle </span><span style="color:var(--astro-code-token-function)">exec</span><span style="color:var(--astro-code-color-text)"> $*</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">else</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-function)">command</span><span style="color:var(--astro-code-color-text)"> $*</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">fi</span></span></code></pre>
<p>It’s very simple.  If there’s a <code>Gemfile</code> in the pwd, it runs commands through bundle exec.  Otherwise it just runs them.</p>
<p>I’ve combined this with some aliases for much less pain and less frustration:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">alias</span><span style="color:var(--astro-code-color-text)"> rake=</span><span style="color:var(--astro-code-token-string-expression)">&#39;be rake&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">alias</span><span style="color:var(--astro-code-color-text)"> cap=</span><span style="color:var(--astro-code-token-string-expression)">&#39;be cap&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">alias</span><span style="color:var(--astro-code-color-text)"> rspec=</span><span style="color:var(--astro-code-token-string-expression)">&#39;be rspec&#39;</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2011/09/a-small-toy-to-explore-geohashes">A small toy to explore geohashes</a>
            </h2>
            <p>For an app I’ve been building, I’ve been looking into <a href="http://geohash.org/">geohashes</a>.  For those who don’t know, the <a href="http://en.wikipedia.org/wiki/Geohash">geohash</a> format is a simple way to encode latitude and longitude into a single string.  As an example, Nelson’s Column in London (51.507794, -0.127952) has the geohash <code>gcpvj0dyds</code>.</p>
<p>Geohashes have a couple of interesting features.  First, as you remove characters, you lose precision. <code>gcpvj0dyds</code> fairly accurately points to Nelson’s Column; <code>gcpvj0d</code> represents the South-West of Trafalgar Square and some of the Mall; and <code>gcpvj</code> covers most of Central London, as well as Islington and King’s Cross.  A geohash doesn’t really represent a point, but rather a bounding area within which a point may lie.  The longer the geohash, the smaller that bounding area.</p>
<p>The other interesting property geohashes have is that nearby locations usually (but not always) share similar prefixes.  So much of North London is in <code>gcpv</code>, while much of South London is in <code>gcpu</code>.  However, due to the <a href="http://en.wikipedia.org/wiki/Prime_Meridian">Prime Meridian</a> passing through Greenwhich, South East London has the geohash <code>u10h</code> - wildly different than the other two.</p>
<p>This probably sounds a bit complicated.  I was having trouble getting my head around the concept, so to try and get to grips with geohashes I’ve written a toy app that draws them on a map.  To try it out, go to <a href="http://geohash.gofreerange.com">http://geohash.gofreerange.com</a>, click the map, zoom and play.  If you find it useful, let me know.</p>
<div class="update"><p>Update: This code is now available <a href="https://github.com/tomafro/geohash-explorer">on github</a>.</p></div>
          </li><li>
            <h2>
              <a href="/2011/09/geohash-toy-code-released">Geohash toy: code released</a>
            </h2>
            <p>A couple of weeks ago I <a href="http://tomafro.net/2011/09/a-small-toy-to-explore-geohashes">wrote about a small toy app</a> I’d written to explore geohashes.  Now I’ve cleaned the code up a little, upgraded it to rails 3.1 and released it <a href="https://github.com/tomafro/geohash-explorer">here on github</a>.  Enjoy.</p>
          </li><li>
            <h2>
              <a href="/2012/02/working-inside-government">Working inside government</a>
            </h2>
            <p>Since September, I and the other <a href="http://gofreerange.com">Go Free Range</a> guys have been working for the government.  We’ve been helping the able and growing <a href="http://digital.cabinetoffice.gov.uk/">Government Digital Service</a> to build <a href="https://github.com/alphagov/whitehall">whitehall</a>, our code name for the <a href="https://www.gov.uk/government">Inside Government section of gov.uk</a>.  Yesterday we removed the password and opened our doors to the public.</p>
<div class="browsershots"><a href="https://www.gov.uk/government/organisations/department-for-international-development"><img class="browsershot" src="/images/dfid.thumb.png"/></a><a href="https://www.gov.uk/government/policies/human-rights"><img class="browsershot" src="/images/promoting-human-rights.thumb.png"/></a><a href="https://www.gov.uk/government/organisations"><img class="browsershot" src="/images/departments.thumb.png"/></a></div>
<p>For those who don’t know, <a href="https://www.gov.uk">gov.uk</a> is the UK government’s attempt to not only consolidate government websites to a single domain, but also build these sites in the right way.  That means <a href="https://www.pivotaltracker.com/projects/367813">public</a>, <a href="https://github.com/alphagov/whitehall">open source</a>, continual delivery and more.</p>
<p>While the first part of <a href="https://www.gov.uk">gov.uk</a> focussed on helping citizens, <a href="https://www.gov.uk/government">Inside Government</a> is about the business of government.  <a href="https://www.gov.uk/government/policy-topics">What policies</a> the government has, <a href="https://www.gov.uk/government/policies/launching-the-single-domain">how it’s implementing them</a>, not to mention the <a href="https://www.gov.uk/government/news-and-speeches">news and speeches</a>, <a href="https://www.gov.uk/government/publications">publications</a>, <a href="https://www.gov.uk/government/consultations">consultations</a> and other things the government does each day.</p>
<p>It’s only the first release of many, a small glimpse into what will one day be.  How it ends up will be shaped by <a href="https://www.gov.uk/feedback">feedback from the people who use it</a>.</p>
          </li><li>
            <h2>
              <a href="/2012/06/tip-bundler-with-binstubs">Tip: Bundler with --binstubs</a>
            </h2>
            <p>In <a href="/2011/09/tip-automatic-bundle-exec-for-rake-and-more">a previous blog</a>, I wrote how I’d aliased commands such as <code>rake</code>, <code>cap</code> and <code>rspec</code> to run either with or without <code>bundle exec</code>, based on the presence of a <code>Gemfile</code>.  I gave up on that a while ago.  Instead, I’ve started installing all my bundles like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">bundle install --path .bundle/gems --binstubs .bundle/bin</span></span></code></pre>
<p>I often use features like <code>bundle open &lt;gem&gt;</code> to debug and edit failing gems, so I like to keep each application’s gems isolated.  The <code>--path .bundle/gems</code> installs them within an application’s <code>.bundle</code> directory.  As well as isolating my gems, it has the added benefit that I can blow away the gemset with <code>rm -rf .bundle</code></p>
<p>The <code>--binstubs .bundle/bin</code> option installs bundle-aware scripts for each command provided by a bundled gem.  For example, a bundle including <code>rake</code> will generate a <code>.bundle/bin/rake</code> script.  By adding <code>./.bundle/bin</code> to the front of my environment <code>PATH</code>, the bundled version of <code>rake</code> will run when I’m in the application folder.  I never have to type <code>bundle exec</code>!</p>
<p>Obviously typing that long <code>bundle install</code> command each time is tedious, so I’ve aliased it to <code>bi</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-function)">alias</span><span style="color:var(--astro-code-color-text)"> bi=</span><span style="color:var(--astro-code-token-string-expression)">&#39;bundle install --path .bundle/gems --binstubs .bundle/bin&#39;</span></span></code></pre>
<p>I’ve been using these options for a few months, and so far I’m very happy with them.</p>
          </li><li>
            <h2>
              <a href="/2012/11/past-present-future">Past, Present and Future</a>
            </h2>
            <p>For me and the rest of <a href="https://gofreerange.com">Go Free Range</a>, the big event this week was the public launch of <a href="https://www.gov.uk/government">Inside Government</a>, the government focussed part of <a href="https://www.gov.uk">GOV.UK</a>.  Inside Government aims to replace the majority of government department and agency websites with a single place for all news, policies, publications and consultations.  On Wednesday, the first two department websites (for the <a href="https://www.gov.uk/dft">Department for Transport</a> and the <a href="https://www.gov.uk/dclg">Department for Communities and Local Government</a>) were moved across.</p>
<div class="browsershots"><a href="https://www.gov.uk/government"><img class="browsershot" src="/images/inside-government.png"/></a><a href="https://www.gov.uk/government/organisations/department-for-communities-and-local-government"><img class="browsershot" src="/images/inside-government-dclg.png"/></a><a href="https://www.gov.uk/government/policies/bringing-people-together-in-strong-united-communities"><img class="browsershot" src="/images/inside-government-policy.png"/></a></div>
<p>We’ve been working on this project for 14 months, from the <a href="https://github.com/alphagov/whitehall/commit/8fa2772">initial commit</a>, through the <a href="http://tomafro.net/2012/02/working-inside-government">beta launch</a> right up until today.  I’ve enjoyed it, but it has been extremely hard work.  And although there are hundreds of things I’d still like to change, there are hundreds more I’m proud of.</p>
<h2 id="harmonia">Harmonia</h2>
<p>As well as <a href="https://www.gov.uk/government">Inside Government</a>, we’ve also been slowly inviting people to <a href="https://harmonia.io">Harmonia</a>, our ‘virtual office manager’.  In case you haven’t read the <a href="http://gofreerange.com/blog">Go Free Range blog</a>, <a href="https://harmonia.io">Harmonia</a> is a tool we use to assign all the tasks needed to keep our company running.  Rather than use a schedule, each piece of work is assigned in a way designed to be both random and fair.</p>
<div class="browsershots"><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-signup.png"/></a><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-dashboard.png"/></a><a href="https://harmonia.io"><img class="browsershot" src="/images/harmonia-task.png"/></a></div>
<p>One variation or another of <a href="https://harmonia.io">Harmonia</a> has been helping us for well over a year, but now we’ve built a web app for everyone to use.  It’s still a bit rough around the edges, but we’d love it if people <a href="https://harmonia.io">signed up</a> and gave us feedback.  We’re building this because we want to learn how to build better products, for the future of <a href="http://gofreerange.com">Go Free Range</a>.</p>
          </li><li>
            <h2>
              <a href="/2012/12/deploying-harmonia-with-recap">Deploying a rails app from scratch using recap</a>
            </h2>
            <p>If you follow <a href="http://gofreerange.com/blog">our company blog</a> you’ll know that we’re working on <a href="http://harmonia.io">Harmonia</a>, our virtual office manager.  I thought I’d explain how we use <a href="https://github.com/freerange/recap">recap</a> to deploy harmonia, to show how easy and fast <a href="https://github.com/freerange/recap">recap</a> makes application deployment.</p>
<p><a href="https://harmonia.io">Harmonia</a> is a fairly standard rails application.  As well as a web front-end, it has two other processes.  A queue <code>worker</code> is used to send outgoing emails, whilst the core of the application is the <code>ticker</code>; a process which ‘ticks’ every minute, assigning tasks to team members.  We use <a href="https://github.com/ddollar/foreman">foreman</a> to declare these processes in the following <code>Procfile</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">web</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec unicorn -p $PORT -c unicorn.conf.rb</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">ticker</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec rails runner script/ticker.rb</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">worker</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">bundle exec rake environment resque:work QUEUE=assignments VVERBOSE=1</span></span></code></pre>
<p>All of these processes touch application code, so whenever we deploy a new version of the app (which we do frequently) they need to be restarted.  Our app also has a database with associated migrations, uses environment variables like <code>DATABASE_URL</code> for configuration, and has a number of gem dependencies managed by bundler.</p>
<p>This is all handled by <a href="https://github.com/freerange/recap">recap</a>.</p>
<h2 id="getting-started---adding-recap-to-the-project">Getting started - adding recap to the project</h2>
<p>Using recap with a rails project is simple.  First add <code>gem &#39;recap&#39;</code> to the <code>Gemfile</code> and run <code>bundle install</code>.  Next run <code>bundle exec recap setup</code>, which will generate a <code>Capfile</code>, guessing values for the git repository and app name.  You should check these values and change the server to point to your app server.  As an example, the complete <code>Capfile</code> for harmonia is shown below:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">require</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;recap/recipes/rails&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">set :application</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;harmonia&#39;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">set :repository</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&#39;git@github.com:freerange/harmonia.git&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">server </span><span style="color:var(--astro-code-token-string-expression)">&#39;bison.harmonia.io&#39;</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> :app</span></span></code></pre>
<p>Applications deployed with <a href="https://github.com/freerange/recap">recap</a> need their own user, owning all files and processes.  Assuming we can <code>ssh</code> into our server and are listed as a <code>sudoer</code>, we can create this user automatically  running <code>cap bootstrap</code>.  This will also add our own <code>ssh</code> user to the application group, allowing it to deploy the application.</p>
<p>Next we can set any environment variables we need for configuration.  These are loaded in the application user’s <code>.profile</code>, so are available to all processes started by <a href="https://github.com/freerange/recap">recap</a>.  In harmonia we set our smtp credentials, the server port, some api keys and more, using commands like <code>cap env:set PORT=7000</code> and <code>cap env:set SMTP_PASSWORD=secret</code>.</p>
<p>The app is now almost ready to deploy.  We can prepare it for deployment with <code>cap deploy:setup</code>, which clones the code repository, installs our gem bundle, sets up the database and precompiles our assets.</p>
<p>Finally, running <code>cap deploy</code> will start the app for the first time, launching each process defined in the <code>Procfile</code> with the environment variables we previously set.</p>
<h2 id="really-fast-deployments">Really fast deployments</h2>
<p>While <a href="https://github.com/freerange/recap">recap</a> makes it very easy to get apps up and running the first time, it comes into its doing subsequent deployments.  At <a href="http://gofreerange.com">Go Free Range</a> we like to deploy apps we’re working on very frequently.  One thing that helps ensure we do this is making each deployment as fast as it can be.</p>
<p>Using <code>git</code> as recap does is already a very quick way to get code changes onto servers, but recap takes things a step further.  By testing to see which files have changed it knows which tasks can be skipped.  For example, database migrations won’t be run if <code>db/schema.rb</code> has not changed; the gem bundle won’t be re-installed unless <code>Gemfile.lock</code> has been updated, and foreman process scripts won’t be exported if the <code>Procfile</code> is unchanged.  In fact, if these files don’t exist, these tasks will never run at all.</p>
<h2 id="the-future">The future</h2>
<p>Using <a href="https://github.com/freerange/recap">recap</a> with <a href="https://harmonia.io">Harmonia</a> has made our deployment process very fast and simple.  When the main harmonia server became over-burdened and we decided to commission a new machine dedicated to harmonia, recap made that process quick and painless.  As well as harmonia, recap is also used to deploy <a href="http://gofreerange.com">the Go Free Range website</a>, <a href="http://tomafro.net">this blog</a>, and a number of other small sites and projects where it has proven itself well.  For larger projects, there are some features (such as more control as to what processes run where) that are missing, but I plan to add these in the next release.  For all other sites, recap has proven itself a lightweight and capable alternative to the standard Capistrano deployment recipes.</p>
          </li><li>
            <h2>
              <a href="/2012/12/infinite-sequences-in-ruby">Infinite sequences in ruby</a>
            </h2>
            <p>One feature of <a href="https://harmonia.io">harmonia</a> is tasks that recur on a schedule, e.g. every Thursday, or on the 30th day of each month.  For these tasks we need to know not just when they’ll next occur, but also things like the next 4 occurrences, or all occurrences this month.</p>
<p>To do this we’ve used a technique more common in <a href="http://clojure.org/">clojure</a>: using an infinite sequence.</p>
<h2 id="defining-simple-infinite-sequences">Defining simple infinite sequences</h2>
<p>Ruby 1.9 and above let us define infinite sequences using the <code>Enumerator</code> class.  A simple example is the sequence of integers:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Here’s how this works.  The block passed to <code>Enumerator.new</code> defines our sequence.  It takes a <code>yielder</code> argument with a special method <code>#yield</code>, used to return elements in the sequence.  Whenever <code>#yield</code> is called, execution of the block stops.  Execution only restarts <em>if</em> more elements are needed, making the sequence <em>lazy</em>.  The <code>Enumerator</code> class handles this stopping and starting execution — we only need to worry about how to generate each element.</p>
<p>Most of the code above is concerned with looping and yielding values, not generating them.  We can factor this out, giving us a method that makes it trivial to define new sequences:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>When using infinite sequences laziness is extremely important, as it’s impossible to generate all members of an infinite list in anything less than infinite time.  A sequence that outputs whenever a new value is calculated shows this laziness in action:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Calculating result </span><span style="color:var(--astro-code-token-string-expression)">#{n}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-punctuation)">;</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Now we can define sequences, how can we use them?  We’ve already seen that we can <code>#take</code> any number of elements from our sequence.  We can also use <code>#take_while</code> to take elements until a condition is met, such as finding all square numbers under 250:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take_while {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">250</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">100</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">144</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">196</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>In fact all <code>Enumerable</code> methods are available, but we have to take care in using them.  As our sequences are infinite, any method that iterates over all members has the potential to take an infinite amount of time.  For example calling <code>#any?</code> will either return true (if a matching element exists) or never return.</p>
<p>Another big drawback is that when we call <code>Enumerable</code> methods, laziness isn’t preserved.  Suppose we want the first 5 odd square numbers.  We might try the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span></code></pre>
<p>Unfortunately this will never return.  Even though we only want a finite set of results, the call to <code>#select</code> operates on the full infinite sequence before it returns.  <code>#take(5)</code> is never called.  The same problem exists with <code>#map</code>, <code>#drop</code>, <code>#reject</code> and more.</p>
<h2 id="preserving-laziness-across-derived-sequences">Preserving laziness across derived sequences</h2>
<p>Without laziness preservation, our sequences seem of limited use.  In ruby 2.0 we can use <code>#lazy</code> to make our sequences lazier, but in 1.9 this isn’t available to us.  Thankfully we can get around this by generating lazy versions of Enumerable methods ourselves.  Let’s take the previous example, finding the first 5 odd square numbers.  We hit a roadblock because <code>#select</code> never returned.  If instead of using <code>#select</code> we use a new <code>Enumerator</code> to do our selecting, we can work around this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">square</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield square </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> (square </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">289</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">361</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Our new <code>Enumerator</code> iterates <em>lazily</em> through our original sequence, yielding only odd values.  We’ve chained two enumerators together to preserve laziness.</p>
<p>This is all a bit cumbersome as is, but we can turn this into a ‘#select’ method on a new <code>LazyEnumerator</code> class:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">lazy_sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">LazyEnumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p><code>#reject</code> and <code>#map</code> can be chained in a similar way to <code>#select</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">reject</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">unless</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">map</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p><code>#drop</code> and <code>#drop_while</code> are slightly more complicated, but follow a similar pattern.  The main difference being that they need to keep track of how much to drop:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">n</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped_enough </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> index</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped_enough </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">&gt;=</span><span style="color:var(--astro-code-color-text)"> n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> dropped_enough</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop_while</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      match_found </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        match_found </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(element)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> match_found</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Together, these methods give us a <code>LazyEnumerator</code> that can be chained in a great number of ways, giving our sequences a lot of power.  <code>#take</code> and <code>#drop</code> let us select which members of a sequence we’re interested, while <code>#select</code>, <code>#reject</code> and <code>#map</code> allow us to build new sequences from existing ones:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">map {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">drop(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">441</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">529</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">625</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">729</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">841</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">961</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1089</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1369</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1521</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Using only a few simple methods, we’ve been able to answer a complicated (though contrived) question, what are the second ten odd square numbers?  This particular answer may not be interesting, but the technique of defining and deriving infinite sequences is much more general and useful.  This is only a small sample of what you can do with them.</p>
          </li><li>
            <h2>
              <a href="/2021/08/faster-builds-with-docker">Fast build dependencies with docker</a>
            </h2>
            <p>Recently at <a href="https://farill.io">farill.io</a> we’ve rewritten our CI pipeline, moving from <a href="https://circleci.com/">CircleCI</a> to <a href="https://buildkite.com">buildkite</a>. Our builds should finish as quickly as possible, so we’ve split them into several discrete steps, many of which can run in parallel. Each step runs in a dedicated docker container (via the <a href="https://github.com/buildkite-plugins/docker-compose-buildkite-plugin">buildkite docker-compose plugin</a>), sharing nothing with other steps in the pipeline. To keep the build fast they must start up as fast as possible, so we use a special builder image that already includes all tools and dependencies (such as gems, javascript modules, clojure libraries, etc).</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> ubuntu:20.04 </span><span style="color:var(--astro-code-token-keyword)">AS</span><span style="color:var(--astro-code-color-text)"> base</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)"># ...install all the tools needed for the build, such as</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)"># ruby, node, yarn, etc...</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">ENV</span><span style="color:var(--astro-code-color-text)"> GEM_HOME ${HOME}/ruby/gems</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">ENV</span><span style="color:var(--astro-code-color-text)"> BUNDLE_PATH ${HOME}/ruby/bundle</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">ENV</span><span style="color:var(--astro-code-color-text)"> BUNDLE_BIN ${HOME}/ruby/bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> base </span><span style="color:var(--astro-code-token-keyword)">AS</span><span style="color:var(--astro-code-color-text)"> ruby</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">COPY</span><span style="color:var(--astro-code-color-text)"> Gemfile Gemfile</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">COPY</span><span style="color:var(--astro-code-color-text)"> Gemfile.lock Gemfile.lock</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">RUN</span><span style="color:var(--astro-code-color-text)"> bundle install</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">FROM</span><span style="color:var(--astro-code-color-text)"> base </span><span style="color:var(--astro-code-token-keyword)">AS</span><span style="color:var(--astro-code-color-text)"> build</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">COPY</span><span style="color:var(--astro-code-color-text)"> --from=ruby ${GEM_HOME} ${GEM_HOME}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">COPY</span><span style="color:var(--astro-code-color-text)"> --from=ruby ${BUNDLE_BIN} ${BUNDLE_BIN}</span></span></code></pre>
          </li><li>
            <h2>
              <a href="/2023/02/using-direnv-to-make-life-easier">Using direnv to make life easier</a>
            </h2>
            <p>One of the tools I find most useful for local development is <a href="https://direnv.net/">direnv</a>. It’s one of a number of similar utilities that hooks into your shell, and alters the environment when you enter or leave a directory.</p>
<p>To give you an example, if you have a folder <code>~/example</code> with the file <code>~/example/.envrc</code></p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> EXAMPLE_NAME=</span><span style="color:var(--astro-code-token-string-expression)">&quot;Danie&quot;</span></span></code></pre>
<p>Then when in your shell session you <code>cd</code> into <code>~/example</code> it will export the <code>EXAMPLE_NAME</code> variable:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/example</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: loading </span><span style="color:var(--astro-code-token-keyword)">~</span><span style="color:var(--astro-code-color-text)">/example/.envrc</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: </span><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> +EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">echo</span><span style="color:var(--astro-code-color-text)"> Hello $EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">Hello Danie</span></span></code></pre>
<p>Just as importantly, when you navigate away, the variable will be unset:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">cd</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">~</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">direnv: unloading</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">❯ </span><span style="color:var(--astro-code-token-function)">echo</span><span style="color:var(--astro-code-color-text)"> Hello $EXAMPLE_NAME</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">Hello</span></span></code></pre>
<h2 id="simple-use-cases">Simple use cases</h2>
<p>More command line tools than you might think make use of environment variables, as of course does your shell. There are some obvious and less obvious uses for direnv. Here are a few that I use:</p>
<h3 id="quickly-launch-the-correct-development-database">QUICKLY LAUNCH THE CORRECT DEVELOPMENT DATABASE</h3>
<p>Setting <a href="https://www.postgresql.org/docs/current/libpq-envars.html">Postgres Environment Variables</a> <code>PGDATABASE</code>, <code>PGUSER</code>, and <code>PGPASSWORD</code><sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup> to match my development database credentials means that when in a project folder, <code>psql</code> will open the correct database.</p>
<h3 id="securely-use-aws-secrets-via-1password">SECURELY USE AWS SECRETS (via 1Password)</h3>
<p>Unlike a development database password, I’m more careful with AWS credentials. While <code>AWS_PROFILE</code>, <code>AWS_REGION</code>, and <code>AWS_ACCESS_KEY_ID</code> are safe to share, I prefer to keep <code>AWS_SECRET_ACCESS_KEY</code> values out of my <code>.envrc</code> files. But that doesn’t mean I can’t use them. I store these secrets in 1Password and use the CLI to retrieve them. So my <code>.envrc</code> looks like this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_REGION=eu-west-2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_ACCESS_KEY_ID=AKABCDEFGHIJKLMNO</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">export</span><span style="color:var(--astro-code-color-text)"> AWS_SECRET_ACCESS_KEY=</span><span style="color:var(--astro-code-token-string-expression)">&quot;$(op </span><span style="color:var(--astro-code-token-function)">read</span><span style="color:var(--astro-code-token-string-expression)"> op://dev/aws/SECRET_ACCESS_KEY)&quot;</span></span></code></pre>
<p>The environment variable is still set to the secret, but the secret itself is stored more securely than in an unencrypted <code>.envrc</code>.</p>
<h3 id="add-arbitrary-commands-to-the-path">Add arbitrary commands to the path</h3>
<p>In one of the clojure projects I work on, the command I use start the REPL is:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">clojure -A:dev:test:backend:backend-test:system-test:repl</span></span></code></pre>
<p>To save having to type this (or more accurately — search the shell history), I put it in a very short script, saved (and <code>.gitignored</code>) in <code>.local/bin/repl</code>. Then in that project’s <code>.envrc</code> I’ve simply put:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">PATH_add ./.local/bin</span></span></code></pre>
<p>When in this project folder, typing <code>repl</code> launches the repl.</p>
<section data-footnotes="" class="footnotes"><p class="sr-only" id="footnote-label">Footnotes</p>
<ol>
<li id="user-content-fn-1">
<p>If I’d set one. YOLO. <a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>
          </li>
  </ul>
  </div>
</main>
    
  </body></html>