<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tom Ward's personal website">
    <meta name="sha">
    <link rel="alternate" type="application/rss+xml" title="Weeknotes RSS feed for Tom Ward's Blog" href="/weeknotes/rss.xml">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preload" href="/fonts/rubik.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/rubik-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/bitter-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/fira-code.woff2" as="font" type="font/woff2" crossorigin>
    <meta name="generator" content="Astro v2.0.14">
    <title>Infinite sequences in ruby - Tom Ward's Blog</title>
  <link rel="stylesheet" href="/_astro/_...slug_.5b1b7a84.css" /></head>
  <body class="baseline">
    

<header class="astro-WOK3G3JL" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="container astro-WOK3G3JL">
    <nav class="astro-WOK3G3JL">
      <ul class="sections astro-WOK3G3JL">
        <li class="astro-WOK3G3JL"><a href="/" class="astro-WOK3G3JL">About</a></li>
        <li class="astro-WOK3G3JL"><a href="/weeknotes" class="astro-WOK3G3JL">Weeknotes</a></li>
        <li class="astro-WOK3G3JL"><a href="/projects" class="astro-WOK3G3JL">Projects</a></li>
      </ul>
      <ul class="icons astro-WOK3G3JL">
        <li class="astro-WOK3G3JL">
          <a href="https://hachyderm.io/@tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://instagram.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path>
</svg></a>
        </li>
        <li class="astro-WOK3G3JL">
          <a href="https://github.com/tomafro" class="astro-WOK3G3JL">

<svg class="icon astro-PATNJMLL" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
  <path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path>
</svg></a>
        </li>
      </ul>
    </nav>
  </div>
</header>
    
<main class="astro-UGUFLI7P" style="--maxWidth: 50rem;--gutterSize: 0.5rem;">
  <div class="bounds astro-UGUFLI7P">
    <article>
    <hgroup>
      <h1>Infinite sequences in ruby</h1>
      <h2>
            <time datetime="2012-12-31T00:00:00.000Z">December 31st 2012</time>
          </h2>
    </hgroup>
    <p>One feature of <a href="https://harmonia.io">harmonia</a> is tasks that recur on a schedule, e.g. every Thursday, or on the 30th day of each month.  For these tasks we need to know not just when they’ll next occur, but also things like the next 4 occurrences, or all occurrences this month.</p>
<p>To do this we’ve used a technique more common in <a href="http://clojure.org/">clojure</a>: using an infinite sequence.</p>
<h2 id="defining-simple-infinite-sequences">Defining simple infinite sequences</h2>
<p>Ruby 1.9 and above let us define infinite sequences using the <code>Enumerator</code> class.  A simple example is the sequence of integers:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Here’s how this works.  The block passed to <code>Enumerator.new</code> defines our sequence.  It takes a <code>yielder</code> argument with a special method <code>#yield</code>, used to return elements in the sequence.  Whenever <code>#yield</code> is called, execution of the block stops.  Execution only restarts <em>if</em> more elements are needed, making the sequence <em>lazy</em>.  The <code>Enumerator</code> class handles this stopping and starting execution — we only need to worry about how to generate each element.</p>
<p>Most of the code above is concerned with looping and yielding values, not generating them.  We can factor this out, giving us a method that makes it trivial to define new sequences:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">6</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">7</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">8</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>When using infinite sequences laziness is extremely important, as it’s impossible to generate all members of an infinite list in anything less than infinite time.  A sequence that outputs whenever a new value is calculated shows this laziness in action:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">puts</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-string-expression)">&quot;Calculating result </span><span style="color:var(--astro-code-token-string-expression)">#{n}</span><span style="color:var(--astro-code-token-string-expression)">&quot;</span><span style="color:var(--astro-code-token-punctuation)">;</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Calculating</span><span style="color:var(--astro-code-color-text)"> result </span><span style="color:var(--astro-code-token-constant)">2</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">3</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Now we can define sequences, how can we use them?  We’ve already seen that we can <code>#take</code> any number of elements from our sequence.  We can also use <code>#take_while</code> to take elements until a condition is met, such as finding all square numbers under 250:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take_while {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">250</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">4</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">16</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">36</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">64</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">100</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">144</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">196</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>In fact all <code>Enumerable</code> methods are available, but we have to take care in using them.  As our sequences are infinite, any method that iterates over all members has the potential to take an infinite amount of time.  For example calling <code>#any?</code> will either return true (if a matching element exists) or never return.</p>
<p>Another big drawback is that when we call <code>Enumerable</code> methods, laziness isn’t preserved.  Suppose we want the first 5 odd square numbers.  We might try the following:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span></code></pre>
<p>Unfortunately this will never return.  Even though we only want a finite set of results, the call to <code>#select</code> operates on the full infinite sequence before it returns.  <code>#take(5)</code> is never called.  The same problem exists with <code>#map</code>, <code>#drop</code>, <code>#reject</code> and more.</p>
<h2 id="preserving-laziness-across-derived-sequences">Preserving laziness across derived sequences</h2>
<p>Without laziness preservation, our sequences seem of limited use.  In ruby 2.0 we can use <code>#lazy</code> to make our sequences lazier, but in 1.9 this isn’t available to us.  Thankfully we can get around this by generating lazy versions of Enumerable methods ourselves.  Let’s take the previous example, finding the first 5 odd square numbers.  We hit a roadblock because <code>#select</code> never returned.  If instead of using <code>#select</code> we use a new <code>Enumerator</code> to do our selecting, we can work around this:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-color-text)">odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">Enumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">square</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield square </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> (square </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">121</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">169</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">289</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">361</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Our new <code>Enumerator</code> iterates <em>lazily</em> through our original sequence, yielding only odd values.  We’ve chained two enumerators together to preserve laziness.</p>
<p>This is all a bit cumbersome as is, but we can turn this into a ‘#select’ method on a new <code>LazyEnumerator</code> class:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">lazy_sequence</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">generator</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-constant)">LazyEnumerator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">loop</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield generator</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(n)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      n </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> lazy_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">9</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">25</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">49</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">81</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p><code>#reject</code> and <code>#map</code> can be chained in a similar way to <code>#select</code>:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">reject</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield value </span><span style="color:var(--astro-code-token-keyword)">unless</span><span style="color:var(--astro-code-color-text)"> block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">map</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">value</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(value)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p><code>#drop</code> and <code>#drop_while</code> are slightly more complicated, but follow a similar pattern.  The main difference being that they need to keep track of how much to drop:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">LazyEnumerator</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">&lt;</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">Enumerator</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-parameter)">n</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped_enough </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">0</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> index</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped_enough </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">&gt;=</span><span style="color:var(--astro-code-color-text)"> n</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> dropped_enough</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        dropped </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> dropped </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">def</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-function)">drop_while</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">&amp;</span><span style="color:var(--astro-code-token-parameter)">block</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    self</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">class</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">yielder</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      match_found </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">false</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      each </span><span style="color:var(--astro-code-token-keyword)">do</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">element</span><span style="color:var(--astro-code-token-punctuation)">|</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        match_found </span><span style="color:var(--astro-code-token-keyword)">||=</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">block</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">call(element)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        yielder</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">yield element </span><span style="color:var(--astro-code-token-keyword)">if</span><span style="color:var(--astro-code-color-text)"> match_found</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  </span><span style="color:var(--astro-code-token-keyword)">end</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">end</span></span></code></pre>
<p>Together, these methods give us a <code>LazyEnumerator</code> that can be chained in a great number of ways, giving our sequences a lot of power.  <code>#take</code> and <code>#drop</code> let us select which members of a sequence we’re interested, while <code>#select</code>, <code>#reject</code> and <code>#map</code> allow us to build new sequences from existing ones:</p>
<pre class="astro-code" style="background-color:var(--astro-code-color-background);overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> integers </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> lazy_sequence {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> integers</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">map {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">*</span><span style="color:var(--astro-code-color-text)"> n }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-token-function)">select</span><span style="color:var(--astro-code-color-text)"> {</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)">n</span><span style="color:var(--astro-code-token-punctuation)">|</span><span style="color:var(--astro-code-color-text)"> n </span><span style="color:var(--astro-code-token-keyword)">%</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">2</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-keyword)">==</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">&gt;&gt;</span><span style="color:var(--astro-code-color-text)"> odd_squares</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">drop(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">.</span><span style="color:var(--astro-code-color-text)">take(</span><span style="color:var(--astro-code-token-constant)">10</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">=&gt;</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-constant)">441</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">529</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">625</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">729</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">841</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">961</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1089</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1225</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1369</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> </span><span style="color:var(--astro-code-token-constant)">1521</span><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>Using only a few simple methods, we’ve been able to answer a complicated (though contrived) question, what are the second ten odd square numbers?  This particular answer may not be interesting, but the technique of defining and deriving infinite sequences is much more general and useful.  This is only a small sample of what you can do with them.</p>
  </article>
  </div>
</main>
    
  </body></html>